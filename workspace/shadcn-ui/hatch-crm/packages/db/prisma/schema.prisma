generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "views"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions        = [citext()]
}

enum UserRole {
  BROKER
  TEAM_LEAD
  AGENT
  ISA
  MARKETING
  LENDER
  CONSUMER
}

enum PersonStage {
  NEW
  NURTURE
  ACTIVE
  UNDER_CONTRACT
  CLOSED
  LOST
}

enum ConsentChannel {
  EMAIL
  SMS
  VOICE
}

enum ConsentScope {
  PROMOTIONAL
  TRANSACTIONAL
}

enum ConsentStatus {
  GRANTED
  REVOKED
  UNKNOWN
}

enum ListingStatus {
  COMING_SOON
  ACTIVE
  PENDING
  CLOSED
  WITHDRAWN
}

enum TourStatus {
  REQUESTED
  CONFIRMED
  KEPT
  NO_SHOW
  CANCELLED
}

enum AgreementType {
  BUYER_REP
  LISTING
}

enum AgreementStatus {
  DRAFT
  SIGNED
  EXPIRED
}

enum DealStage {
  OFFER
  UNDER_CONTRACT
  CLOSED
  LOST
}

enum OfferStatus {
  SUBMITTED
  COUNTERED
  ACCEPTED
  REJECTED
}

enum MessageChannel {
  EMAIL
  SMS
  VOICE
  IN_APP
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
  BLOCKED
  READ
}

enum AgentInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum OutreachChannel {
  EMAIL
  SMS
}

enum CampaignEnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum OutreachEventStatus {
  QUEUED
  SENT
  FAILED
  SKIPPED
}

enum OrgEventType {
  ORG_CREATED
  BROKER_CREATED_ORG
  AGENT_INVITE_CREATED
  AGENT_INVITE_ACCEPTED
  ORG_FOLDER_CREATED
  ORG_FILE_UPLOADED
  ORG_FILE_CLASSIFIED
  ORG_FILE_EVALUATED
  ORG_LISTING_EVALUATED
  ORG_TRANSACTION_EVALUATED
  ONBOARDING_TEMPLATE_CREATED
  ONBOARDING_TASK_GENERATED
  ONBOARDING_TASK_COMPLETED
  OFFBOARDING_TASK_GENERATED
  OFFBOARDING_TASK_COMPLETED
  ORG_LEAD_CREATED
  ORG_LEAD_STATUS_CHANGED
  ORG_OFFER_INTENT_CREATED
  ORG_OFFER_INTENT_STATUS_CHANGED
  ORG_RENTAL_PROPERTY_CREATED
  ORG_RENTAL_LEASE_CREATED
  ORG_ACCOUNTING_CONNECTED
  ORG_ACCOUNTING_TRANSACTION_SYNCED
  ORG_ACCOUNTING_RENTAL_SYNCED
}

enum NotificationChannel {
  IN_APP
  EMAIL
}

enum NotificationType {
  GENERIC
  LEAD
  OFFER_INTENT
  LISTING
  TRANSACTION
  RENTAL
  COMPLIANCE
  ACCOUNTING
  AI
}

enum InsightType {
  BROKER
  TEAM
  AGENT
  LISTING
  TRANSACTION
  LEAD
  RENTAL
  COMPLIANCE
  RISK
  PRODUCTIVITY
}

model ChatSession {
  id             String        @id @default(cuid())
  organizationId String
  userId         String

  title          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  messages       ChatMessage[]

  @@index([organizationId, userId])
}

model ChatMessage {
  id        String       @id @default(cuid())
  session   ChatSession  @relation(fields: [sessionId], references: [id])
  sessionId String

  role      String       // user | assistant | system
  content   String
  metadata  Json?

  createdAt DateTime     @default(now())

  @@index([sessionId, createdAt])
}

enum AuditActionType {
  LOGIN
  LOGOUT
  ROLE_CHANGED
  MLS_SYNC_TRIGGERED
  ACCOUNTING_SYNC_TRIGGERED
  NOTIFICATION_PREFS_UPDATED
  AI_PERSONA_RUN
  AI_PERSONA_CONFIG_CHANGED
  ONBOARDING_STATE_CHANGED
  OFFBOARDING_STATE_CHANGED
  COMPLIANCE_STATUS_CHANGED
  OTHER
}

enum AgentRiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum AgentMembershipType {
  MLS
  BOARD
  NAR
  OTHER
}

enum AgentMembershipStatus {
  ACTIVE
  PENDING
  EXPIRED
  SUSPENDED
}

enum AgentTrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum AgentLifecycleStage {
  ONBOARDING
  ACTIVE
  OFFBOARDING
}

enum WorkflowType {
  ONBOARDING
  OFFBOARDING
}

enum WorkflowTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum WorkflowTaskTrigger {
  MANUAL
  AGENT_INVITE_ACCEPTED
  CE_INCOMPLETE
  MEMBERSHIP_EXPIRED
  AI_HIGH_RISK
}

enum OrgListingStatus {
  DRAFT
  PENDING_BROKER_APPROVAL
  ACTIVE
  PENDING
  CLOSED
  WITHDRAWN
  EXPIRED
}

enum OrgTransactionStatus {
  PRE_CONTRACT
  UNDER_CONTRACT
  CONTINGENT
  CLOSED
  CANCELLED
}

enum OrgListingDocumentType {
  LISTING_AGREEMENT
  DISCLOSURE
  PHOTOS
  OTHER
}

enum OrgTransactionDocumentType {
  EXECUTED_CONTRACT
  ADDENDUM
  INSPECTION_REPORT
  APPRAISAL
  CLOSING_DISCLOSURE
  OTHER
}

enum ContractInstanceStatus {
  DRAFT
  OUT_FOR_SIGNATURE
  SIGNED
  VOIDED
}

enum SignatureEnvelopeStatus {
  CREATED
  SENT
  COMPLETED
  VOIDED
}

enum ContractFieldSourceType {
  PROPERTY
  PARTY
  BROKERAGE
  ORG
  STATIC
}

enum OrgConversationType {
  DIRECT
  CHANNEL
}

enum OrgChannelVisibility {
  ORG_WIDE
  PRIVATE
}

enum ConversationType {
  EXTERNAL
  INTERNAL
}

enum ConversationParticipantRole {
  OWNER
  MEMBER
  VIEWER
}

enum PipelineStatus {
  DRAFT    @map("draft")
  ACTIVE   @map("active")
  ARCHIVED @map("archived")
}

enum MessageReceiptStatus {
  DELIVERED
  READ
}

enum ActivityType {
  LEAD_CREATED
  CONSENT_CAPTURED
  CONSENT_REVOKED
  TOUR_REQUESTED
  TOUR_CONFIRMED
  TOUR_KEPT
  AGREEMENT_SIGNED
  DEAL_STAGE_CHANGED
  MESSAGE_SENT
  MESSAGE_READ
  MESSAGE_FAILED
  MESSAGE_BLOCKED
  COMPLIANCE_VIOLATION
  ROUTING_ASSIGNED
  CONTACT_MERGE_PROPOSED
  CONTACT_MERGED
  CONTACT_EMAIL_CHANGED
  CONTACT_PHONE_CHANGED
  CONTACT_STAGE_CHANGED
  CONTACT_OWNER_CHANGED
  CONTACT_TAGS_CHANGED
  CONTACT_DELETED
  CONTACT_RESTORED
  NOTE_ADDED
  COMMISSION_PLAN_CREATED
  COMMISSION_PLAN_UPDATED
  COMMISSION_PLAN_ARCHIVED
  COMMISSION_PLAN_ASSIGNED
  COMMISSION_PLAN_ASSIGNMENT_ENDED
  CAP_LEDGER_UPDATED
}

enum RoutingMode {
  FIRST_MATCH
  SCORE_AND_ASSIGN
}

enum LeadSlaType {
  FIRST_TOUCH
  KEPT_APPOINTMENT
}

enum OutboxStatus {
  PENDING
  DELIVERING
  SUCCESS
  FAILED
}

enum MarketingCampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  FAILED
}

enum LeadHistoryEventType {
  STAGE_MOVED
  OWNER_ASSIGNED
  OWNER_UNASSIGNED
  TOUCHPOINT_LOGGED
  NOTE_ADDED
  FILE_ATTACHED
  FIELD_UPDATED
  JOURNEY_STARTED
}

enum QueueVisibility {
  PRIVATE
  TEAM
  ORGANIZATION
}

enum ContactSource {
  MANUAL
  CSV_IMPORT
  PORTAL
  OPEN_HOUSE
  API
  REFERRAL
}

enum BuyerRepStatus {
  ACTIVE
  NONE
  EXPIRED
}

enum LeadScoreTier {
  A
  B
  C
  D
}

enum LeadTaskStatus {
  OPEN
  DONE
}

enum LeadTouchpointType {
  MESSAGE
  CALL
  MEETING
  TASK
  NOTE
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  APPOINTMENT_SET
  UNDER_CONTRACT
  CLOSED
}

enum LeadSource {
  PORTAL_SIGNUP
  LISTING_INQUIRY
  LOI_SUBMISSION
  MANUAL
  OTHER
}

enum OfferIntentStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  DECLINED
  WITHDRAWN
}

enum RentalPropertyType {
  SINGLE_FAMILY
  CONDO
  MULTI_FAMILY
  COMMERCIAL
  OTHER
}

enum RentalTenancyType {
  SEASONAL
  ANNUAL
  MONTH_TO_MONTH
  OTHER
}

enum RentalStatus {
  ACTIVE
  INACTIVE
  UNDER_MGMT
  OFF_MGMT
}

enum RentalUnitStatus {
  VACANT
  OCCUPIED
  RESERVED
}

enum RentalTaxStatus {
  PENDING
  PAID
  OVERDUE
}

enum MlsProvider {
  STELLAR
  NABOR
  MATRIX
  GENERIC
}

enum MlsSyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum SavedSearchFrequency {
  INSTANT
  DAILY
  WEEKLY
}

enum AiCopilotInsightType {
  DAILY_BRIEFING
  LEAD_FOLLOWUP_SUMMARY
  PIPELINE_OVERVIEW
}

enum AiCopilotActionStatus {
  SUGGESTED
  ACCEPTED
  DISMISSED
  COMPLETED
}

enum AccountingProvider {
  QUICKBOOKS
}

enum AccountingSyncStatus {
  PENDING
  SYNCED
  FAILED
}

enum MergeStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PermissionHolderType {
  PROFILE
  PERMISSION_SET
}

enum ShareGranteeType {
  USER
  ROLE
  TEAM
}

enum ShareAccess {
  READ
  WRITE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SHARE
  LOGIN
}

enum AssignmentReasonType {
  CAPACITY
  PERFORMANCE
  GEOGRAPHY
  PRICE_BAND
  CONSENT
  TEN_DLC
  ROUND_ROBIN
  TEAM_POND
}

enum CommissionPlanType {
  FLAT
  TIERED
  CAP
}

enum PlanAssigneeType {
  USER
  TEAM
}

enum ClearCooperationStatus {
  GREEN
  YELLOW
  RED
}

enum JourneyTrigger {
  LEAD_CREATED
  CONSENT_CAPTURED
  TOUR_KEPT
  DEAL_STAGE_CHANGED
}

enum JourneyActionType {
  ASSIGN
  SEND_MESSAGE
  CREATE_TASK
  UPDATE_STAGE
}

enum CalendarEventType {
  SHOWING
  MEETING
  INSPECTION
  CLOSING
  FOLLOW_UP
  MARKETING
  OTHER
}

enum CalendarEventStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum CalendarEventPriority {
  LOW
  MEDIUM
  HIGH
}

enum SavedViewScope {
  PRIVATE
  TEAM
  ORGANIZATION
}

enum CustomFieldEntity {
  CONTACT
  DEAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
}

enum SequenceEnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELED
}

enum SequenceStepStatus {
  PENDING
  SCHEDULED
  SENT
  SKIPPED
  COMPLETED
  FAILED
  CANCELED
}

model Organization {
  id                  String               @id @default(cuid())
  name                String
  plan                String?              @default("standard")
  slug                String?              @unique
  createdByUserId     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  isDemo              Boolean              @default(false)
  tenants             Tenant[]
  users               User[]
  people              Person[]
  queues              Queue[]
  teamMembers         TeamMember[]
  teams               Team[]
  orgMemberships      UserOrgMembership[]
  roles               Role[]
  profiles            Profile[]
  permissionSets      PermissionSet[]
  objectPermissions   ObjectPermission[]
  fieldPermissions    FieldPermission[]
  recordShares        RecordShare[]
  companies           Company[]
  households          Household[]
  customFields        CustomField[]
  sequences           Sequence[]
  messageTemplates    MessageTemplate[]
  campaigns           Campaign[]
  campaignEnrollments CampaignEnrollment[]
  outreachEvents      OutreachEvent[]
  auditEvents         AuditEvent[]

  createdByUser         User?                           @relation("OrganizationsCreatedBy", fields: [createdByUserId], references: [id])
  agentInvites          AgentInvite[]
  orgEvents             OrgEvent[]
  vaultFolders          OrgFolder[]
  vaultFiles            OrgFile[]
  knowledgeDocuments    KnowledgeDocument[]
  conversations         OrgConversation[]
  orgMessages           OrgMessage[]
  livePresences         LivePresence[]
  agentProfiles         AgentProfile[]
  trainingModules       AgentTrainingModule[]
  orgListings           OrgListing[]
  orgTransactions       OrgTransaction[]
  contractTemplates     ContractTemplate[]
  contractInstances     ContractInstance[]
  searchVectors         SearchVector[]
  playbooks             Playbook[]
  workflowTemplates     OrgWorkflowTemplate[]
  agentWorkflowTasks    AgentWorkflowTask[]
  leads                 Lead[]
  offerIntents          OfferIntent[]
  rentalProperties      RentalProperty[]
  rentalLeases          RentalLease[]
  offices               Office[]
  accountingConfig      AccountingIntegrationConfig?
  transactionAccounting TransactionAccountingRecord[]
  rentalLeaseAccounting RentalLeaseAccountingRecord[]
  quickBooksConnection  QuickBooksConnection?
  mlsFeedConfig         MlsFeedConfig?
  mlsSyncRuns          MlsSyncRun[]
  dripCampaigns        DripCampaign[]
  revenueForecasts     RevenueForecast[]
  leadScoreHistory     LeadScoreHistory[]
  listingSearchIndex    ListingSearchIndex[]
  savedListings         SavedListing[]
  savedSearches         SavedSearch[]
  aiCopilotInsights     AiCopilotInsight[]
  aiCopilotActions      AiCopilotActionRecommendation[]
  aiInsights            AiInsight[]
  chatSessions          ChatSession[]
  orgFileComments       OrgFileComment[]
  agentPerformanceSnapshots AgentPerformanceSnapshot[]
  orgDailyAnalytics     OrgDailyAnalytics[]
  agentDailyAnalytics   AgentDailyAnalytics[]
  notifications         Notification[]
  notificationPreferences NotificationPreference[]
  auditLogs             OrgAuditLog[]
  delegatedAccesses     DelegatedAccess[]
}

model Office {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  code           String?
  city           String?
  state          String?
  region         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  users          User[]        @relation("UsersByOffice")
  listings       OrgListing[]  @relation("ListingsByOffice")
  leads          Lead[]        @relation("LeadsByOffice")
  rentals        RentalLease[] @relation("RentalsByOffice")
  transactions   OrgTransaction[] @relation("TransactionsByOffice")
  teams          Team[]
  agentProfiles  AgentProfile[]
}

model Tenant {
  id                      String                   @id @default(cuid())
  organizationId          String
  name                    String
  slug                    String                   @unique
  timezone                String                   @default("America/New_York")
  quietHoursStart         Int                      @default(21) // 24h clock hour
  quietHoursEnd           Int                      @default(8) // 24h clock hour
  inAppRetentionMonths    Int                      @default(18)
  tenDlcReady             Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  organization            Organization             @relation(fields: [organizationId], references: [id])
  users                   User[]
  teams                   Team[]
  people                  Person[]
  companies               Company[]
  households              Household[]
  listings                Listing[]
  consents                Consent[]
  tours                   Tour[]
  agreements              Agreement[]
  deliverabilityMetrics   DeliverabilityMetric[]
  quietHourOverrides      QuietHourOverride[]
  routingLogs             RoutingLog[]
  webhookSubscriptions    WebhookSubscription[]
  personDocuments         PersonDocument[]
  auditLogs               AuditLog[]
  deals                   Deal[]
  offers                  Offer[]
  mlsProfiles             MLSProfile[]
  messages                Message[]
  conversations           Conversation[]
  activities              Activity[]
  outboxEvents            Outbox[]
  calendarEvents          CalendarEvent[]
  assignments             Assignment[]
  journeys                Journey[]
  clearCooperation        ClearCooperationTimer[]
  consentBlocks           CommunicationBlock[]
  teamMembers             TeamMember[]
  savedViews              SavedView[]
  viewPresets             ViewPreset[]
  consumerPortalConfigs   ConsumerPortalConfig[]
  sequences               Sequence[]
  sequenceEnrollments     SequenceEnrollment[]
  messageTemplates        MessageTemplate[]
  campaigns               Campaign[]
  campaignEnrollments     CampaignEnrollment[]
  outreachEvents          OutreachEvent[]
  sequenceStepLogs        SequenceStepLog[]
  mergeProposals          ContactMergeProposal[]
  disclaimerPolicies      DisclaimerPolicy[]
  overrideLogs            OverrideLog[]
  marketingEvents         MarketingEvent[]
  marketingCampaigns      MarketingCampaign[]
  complianceSnapshots     ComplianceStatusDaily[]
  routingRules            RoutingRule[]
  routeEvents             LeadRouteEvent[]
  slaTimers               LeadSlaTimer[]
  commissionPlans         CommissionPlan[]
  planAssignments         PlanAssignment[]
  capLedgers              CapLedger[]
  planSnapshots           PlanSnapshot[]
  pipelines               Pipeline[]
  stages                  Stage[]
  fieldSets               FieldSet[]
  pipelineAutomations     PipelineAutomation[]
  leadFits                LeadFit[]
  events                  Event[]
  leadActivityRollups     LeadActivityRollup[]
  leadNotes               LeadNote[]
  leadTasks               LeadTask[]
  leadTouchpoints         LeadTouchpoint[]
  leadHistories           LeadHistory[]
  consentEvents           ConsentEvent[]
  touchpoints             Touchpoint[]
  queues                  Queue[]
  queueAssignments        QueueAssignment[]
  customFields            CustomField[]
  customFieldValues       CustomFieldValue[]
  customFieldLayouts      CustomFieldLayout[]
  JourneySimulation       JourneySimulation[]
  aiMemories              AiMemory[]
  aiEmployeeInstances     AiEmployeeInstance[]
  aiEmployeeSessions      AiEmployeeSession[]
  aiProposedActions       AiProposedAction[]
  aiExecutionLogs         AiExecutionLog[]
  emailSequences          EmailSequence[]
  emailSteps              EmailStep[]
  leadSequenceEnrollments LeadSequenceEnrollment[]
  emailDrafts             EmailDraft[]
  vectorChunks            VectorChunk[]
  leadScoresV2            LeadScoreV2[]
  clientAnalyticsEvents   ClientAnalyticsEvent[]
}

model AiMemory {
  id        String   @id @default(cuid())
  tenantId  String
  personaId String
  label     String
  details   String
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, personaId, createdAt])
}

model AiEmployeeTemplate {
  id              String               @id @default(cuid())
  key             String               @unique
  displayName     String
  description     String
  systemPrompt    String
  allowedTools    Json
  defaultSettings Json
  isActive        Boolean              @default(true)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  instances       AiEmployeeInstance[]
}

model AiEmployeeInstance {
  id              String              @id @default(cuid())
  templateId      String
  tenantId        String
  userId          String?
  nameOverride    String?
  settings        Json
  status          String
  autoMode        String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  template        AiEmployeeTemplate  @relation(fields: [templateId], references: [id])
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  user            User?               @relation(fields: [userId], references: [id])
  sessions        AiEmployeeSession[]
  proposedActions AiProposedAction[]
  executionLogs   AiExecutionLog[]

  @@index([tenantId, status, templateId])
  @@index([tenantId, userId])
}

model AiEmployeeSession {
  id                 String             @id @default(cuid())
  employeeInstanceId String
  tenantId           String
  userId             String
  channel            String
  contextType        String?
  contextId          String?
  lastInteractionAt  DateTime           @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  employeeInstance   AiEmployeeInstance @relation(fields: [employeeInstanceId], references: [id])
  tenant             Tenant             @relation(fields: [tenantId], references: [id])
  user               User               @relation(fields: [userId], references: [id])
  proposedActions    AiProposedAction[]
  executionLogs      AiExecutionLog[]

  @@index([employeeInstanceId, tenantId, userId])
  @@index([tenantId, channel, contextType, contextId])
}

model AiProposedAction {
  id                 String             @id @default(cuid())
  employeeInstanceId String
  tenantId           String
  userId             String?
  sessionId          String?
  actionType         String
  payload            Json
  status             String
  errorMessage       String?
  requiresApproval   Boolean            @default(true)
  executedAt         DateTime?
  approvedByUserId   String?
  dryRun             Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  employeeInstance   AiEmployeeInstance @relation(fields: [employeeInstanceId], references: [id])
  tenant             Tenant             @relation(fields: [tenantId], references: [id])
  user               User?              @relation("AiProposedActionUser", fields: [userId], references: [id])
  approvedBy         User?              @relation("AiProposedActionApprovedBy", fields: [approvedByUserId], references: [id])
  session            AiEmployeeSession? @relation(fields: [sessionId], references: [id])
  executionLogs      AiExecutionLog[]

  @@index([tenantId, status, requiresApproval])
  @@index([employeeInstanceId, status])
}

model AiExecutionLog {
  id                  String             @id @default(cuid())
  employeeInstanceId  String
  sessionId           String?
  tenantId            String
  userId              String?
  proposedActionId    String?
  toolKey             String?
  input               Json
  output              Json?
  success             Boolean
  errorMessage        String?
  modelName           String?
  rawPromptTokens     Int?
  rawCompletionTokens Int?
  createdAt           DateTime           @default(now())
  employeeInstance    AiEmployeeInstance @relation(fields: [employeeInstanceId], references: [id])
  session             AiEmployeeSession? @relation(fields: [sessionId], references: [id])
  tenant              Tenant             @relation(fields: [tenantId], references: [id])
  user                User?              @relation(fields: [userId], references: [id])
  proposedAction      AiProposedAction?  @relation(fields: [proposedActionId], references: [id])

  @@index([tenantId, success])
  @@index([employeeInstanceId, proposedActionId])
  @@index([sessionId])
}

model Notification {
  id             String             @id @default(cuid())
  organization   Organization       @relation(fields: [organizationId], references: [id])
  organizationId String

  user           User?              @relation(fields: [userId], references: [id])
  userId         String?

  type           NotificationType   @default(GENERIC)
  channel        NotificationChannel @default(IN_APP)

  title          String
  message        String?

  leadId         String?
  offerIntentId  String?
  listingId      String?
  transactionId  String?
  leaseId        String?

  isRead         Boolean            @default(false)
  readAt         DateTime?

  createdAt      DateTime           @default(now())

  @@index([organizationId, userId, isRead, createdAt])
}

model NotificationPreference {
  id               String        @id @default(cuid())
  organization     Organization  @relation(fields: [organizationId], references: [id])
  organizationId   String

  user             User          @relation(fields: [userId], references: [id])
  userId           String

  inAppEnabled     Boolean       @default(true)
  emailEnabled     Boolean       @default(true)

  leadNotificationsEnabled        Boolean @default(true)
  offerIntentNotificationsEnabled Boolean @default(true)
  rentalNotificationsEnabled      Boolean @default(true)
  accountingNotificationsEnabled  Boolean @default(true)
  aiNotificationsEnabled          Boolean @default(true)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([organizationId, userId])
}

model OrgAuditLog {
  id             String          @id @default(cuid())
  organizationId String
  userId         String?
  actionType     AuditActionType @default(OTHER)
  summary        String
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime        @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User?         @relation("UserOrgAuditLogs", fields: [userId], references: [id])

  @@index([organizationId, createdAt])
  @@index([organizationId, userId, createdAt])
}

model EmailSequence {
  id          String                   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  tenant      Tenant                   @relation(fields: [tenantId], references: [id])
  steps       EmailStep[]
  enrollments LeadSequenceEnrollment[]

  @@index([tenantId, name])
}

model EmailStep {
  id         String        @id @default(cuid())
  tenantId   String
  sequenceId String
  stepIndex  Int
  delayHours Int           @default(0)
  subject    String?
  body       String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  sequence   EmailSequence @relation(fields: [sequenceId], references: [id])
  tenant     Tenant        @relation(fields: [tenantId], references: [id])

  @@unique([sequenceId, stepIndex])
  @@index([tenantId, sequenceId])
}

model LeadSequenceEnrollment {
  id          String        @id @default(cuid())
  tenantId    String
  sequenceId  String
  leadId      String
  currentStep Int           @default(0)
  nextSendAt  DateTime?
  lastSentAt  DateTime?
  active      Boolean       @default(true)
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  sequence    EmailSequence @relation(fields: [sequenceId], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  lead        Person        @relation(fields: [leadId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, sequenceId])
  @@index([tenantId, active])
}

model EmailDraft {
  id        String   @id @default(cuid())
  tenantId  String
  leadId    String
  subject   String
  html      String?
  text      String?
  meta      Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  lead      Person   @relation(fields: [leadId], references: [id])
}

model LeadScoreV2 {
  leadId    String   @id
  tenantId  String
  score     Float
  factors   Json
  updatedAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  lead      Person   @relation(fields: [leadId], references: [id])

  @@index([tenantId])
}

model VectorChunk {
  id          String                 @id
  tenantId    String                 @map("tenant_id")
  entityType  String                 @map("entity_type")
  entityId    String                 @map("entity_id")
  chunkIndex  Int                    @map("chunk_index")
  content     String
  embeddingF8 Float[]                @map("embedding_f8")
  meta        Json?                  @map("meta")
  createdAt   DateTime               @default(now()) @map("created_at")
  tenant      Tenant                 @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, entityType, entityId, chunkIndex], map: "vectorchunk_tenant_entity_chunk_uq")
  @@index([tenantId, entityType, entityId], map: "vectorchunk_tenant_entity_idx")
  @@map("VectorChunk")
}

model User {
  id                          String                          @id @default(cuid())
  organizationId              String
  tenantId                    String
  officeId                    String?
  teamId                      String?
  email                       String                          @unique @db.Citext
  firstName                   String
  lastName                    String
  role                        UserRole
  passwordHash                String?
  status                      String                          @default("active")
  avatarUrl                   String?
  timezone                    String?
  createdAt                   DateTime                        @default(now())
  updatedAt                   DateTime                        @updatedAt
  organization                Organization                    @relation(fields: [organizationId], references: [id])
  tenant                      Tenant                          @relation(fields: [tenantId], references: [id])
  office                      Office?                         @relation("UsersByOffice", fields: [officeId], references: [id])
  team                        Team?                           @relation("TeamMembers", fields: [teamId], references: [id])
  memberships                 TeamMembership[]
  orgMemberships              UserOrgMembership[]
  permissionSetAssignments    PermissionSetAssignment[]
  ownedPeople                 Person[]                        @relation("PersonOwner")
  commissionPlansCreated      CommissionPlan[]                @relation("CommissionPlanCreatedBy")
  planAssignmentsCreated      PlanAssignment[]                @relation("PlanAssignmentCreatedBy")
  planSnapshotsCreated        PlanSnapshot[]                  @relation("PlanSnapshotCreatedBy")
  capLedgers                  CapLedger[]
  tours                       Tour[]                          @relation("TourAgent")
  messages                    Message[]
  createdConversations        Conversation[]                  @relation("ConversationCreatedBy")
  conversationMemberships     ConversationParticipant[]       @relation("ConversationParticipantUser")
  assignments                 Assignment[]
  activities                  Activity[]
  calendarEvents              CalendarEvent[]                 @relation("EventAssignedAgent")
  actedConsents               Consent[]                       @relation("ConsentActor")
  overrideAgreements          Agreement[]                     @relation("AgreementOverride")
  deliverabilityMetrics       DeliverabilityMetric[]
  auditLogs                   AuditLog[]
  orgAuditLogs                OrgAuditLog[]          @relation("UserOrgAuditLogs")
  savedViews                  SavedView[]
  proposedMerges              ContactMergeProposal[]          @relation("MergeProposedBy")
  resolvedMerges              ContactMergeProposal[]          @relation("MergeResolvedBy")
  overrideEntries             OverrideLog[]                   @relation("OverrideActor")
  cooperationActions          ClearCooperationTimer[]         @relation("CooperationLastActor")
  routingRulesCreated         RoutingRule[]                   @relation("RoutingRuleCreatedBy")
  routeEventsActor            LeadRouteEvent[]                @relation("RouteEventActor")
  leadNotesAuthored           LeadNote[]                      @relation("LeadNoteAuthor")
  leadTasksAssigned           LeadTask[]                      @relation("LeadTaskAssignee")
  leadTouchpoints             LeadTouchpoint[]
  leadHistoriesAuthored       LeadHistory[]                   @relation("LeadHistoryActor")
  consentEventsActor          ConsentEvent[]                  @relation("ConsentEventActor")
  queueAssignments            QueueAssignment[]               @relation("QueueAssignmentAssignee")
  touchpointsAuthored         Touchpoint[]                    @relation("TouchpointActor")
  auditEvents                 AuditEvent[]
  companiesOwned              Company[]                       @relation("CompanyOwner")
  householdsOwned             Household[]                     @relation("HouseholdOwner")
  sequencesCreated            Sequence[]                      @relation("SequenceCreatedBy")
  sequencesUpdated            Sequence[]                      @relation("SequenceUpdatedBy")
  sequenceEnrollments         SequenceEnrollment[]            @relation("SequenceEnrollmentOwner")
  customFieldsCreated         CustomField[]                   @relation("CustomFieldCreatedBy")
  customFieldsUpdated         CustomField[]                   @relation("CustomFieldUpdatedBy")
  customFieldLayoutsCreated   CustomFieldLayout[]             @relation("CustomFieldLayoutCreatedBy")
  customFieldLayoutsUpdated   CustomFieldLayout[]             @relation("CustomFieldLayoutUpdatedBy")
  aiEmployeeInstances         AiEmployeeInstance[]
  aiEmployeeSessions          AiEmployeeSession[]
  aiProposedActions           AiProposedAction[]              @relation("AiProposedActionUser")
  aiApprovedActions           AiProposedAction[]              @relation("AiProposedActionApprovedBy")
  aiExecutionLogs             AiExecutionLog[]
  marketingCampaigns          MarketingCampaign[]             @relation("MarketingCampaignCreatedBy")
  organizationsCreated        Organization[]                  @relation("OrganizationsCreatedBy")
  agentInvitesSent            AgentInvite[]                   @relation("AgentInvitesInvitedBy")
  agentInvitesAccepted        AgentInvite[]                   @relation("AgentInvitesAcceptedBy")
  orgEventsAsActor            OrgEvent[]                      @relation("OrgEvent_actor")
  chatSessions                ChatSession[]
  orgFilesUploaded            OrgFile[]
  orgFileVersionsCreated      OrgFileVersion[]
  orgFileComments             OrgFileComment[]
  orgFoldersCreated           OrgFolder[]                     @relation("OrgFolderCreatedBy")
  orgConversationsCreated     OrgConversation[]               @relation("OrgConversationCreatedBy")
  orgConversationParticipants OrgConversationParticipant[]
  orgMessagesSent             OrgMessage[]
  agentProfilesForOrgs        AgentProfile[]
  trainingModulesCreated      AgentTrainingModule[]
  workflowTemplatesCreated    OrgWorkflowTemplate[]           @relation("OrgWorkflowTemplateCreatedBy")
  orgListingsCreated          OrgListing[]                    @relation("OrgListing_CreatedBy")
  orgListingsBrokerApproved   OrgListing[]                    @relation("OrgListing_BrokerApproval")
  delegatedAssistants         DelegatedAccess[]               @relation("AgentDelegations")
  delegatedAssignments        DelegatedAccess[]               @relation("AssistantDelegations")
  orgTransactionsCreated      OrgTransaction[]
  contractInstances           ContractInstance[]
  agentWorkflowTasksCompleted AgentWorkflowTask[]             @relation("AgentWorkflowTaskCompletedBy")
  leadsAsConsumer             Lead[]                          @relation("Lead_Consumer")
  leadsCreated                Lead[]                          @relation("Lead_CreatedBy")
  offerIntents                OfferIntent[]
  savedListings               SavedListing[]
  savedSearches               SavedSearch[]
  completedCopilotActions     AiCopilotActionRecommendation[] @relation("AiCopilotActionCompletedBy")
  notifications               Notification[]
  notificationPreferences     NotificationPreference[]
  livePresences               LivePresence[]
}

model OrgListing {
  id                     String           @id @default(cuid())
  organizationId         String
  officeId               String?
  agentProfileId         String?
  mlsNumber              String?          @unique
  addressLine1           String
  addressLine2           String?
  city                   String
  state                  String
  postalCode             String
  country                String?
  listPrice              Int?
  propertyType           String?
  bedrooms               Int?
  bathrooms              Float?
  squareFeet             Int?
  status                 OrgListingStatus @default(DRAFT)
  brokerApproved         Boolean          @default(false)
  brokerApprovedAt       DateTime?
  brokerApprovedByUserId String?
  listedAt               DateTime?
  expiresAt              DateTime?
  withdrawnAt            DateTime?
  createdByUserId        String
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  organization                  Organization                    @relation(fields: [organizationId], references: [id])
  office                        Office?                         @relation("ListingsByOffice", fields: [officeId], references: [id])
  agentProfile                  AgentProfile?                   @relation(fields: [agentProfileId], references: [id])
  brokerApprovedByUser          User?                           @relation("OrgListing_BrokerApproval", fields: [brokerApprovedByUserId], references: [id])
  createdByUser                 User                            @relation("OrgListing_CreatedBy", fields: [createdByUserId], references: [id])
  documents                     OrgListingDocument[]
  files                         OrgFile[]
  transactions                  OrgTransaction[]
  contractInstances             ContractInstance[]
  workflowTasks                 AgentWorkflowTask[]             @relation("AgentWorkflowTaskListing")
  leads                         Lead[]
  offerIntents                  OfferIntent[]
  rentalProperties              RentalProperty[]
  AiCopilotActionRecommendation AiCopilotActionRecommendation[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, status, expiresAt])
}

model OrgListingDocument {
  id        String                 @id @default(cuid())
  listingId String
  orgFileId String
  type      OrgListingDocumentType @default(OTHER)
  createdAt DateTime               @default(now())

  listing OrgListing @relation(fields: [listingId], references: [id])
  orgFile OrgFile    @relation("OrgListingDocument_File", fields: [orgFileId], references: [id])

  @@index([listingId])
}

model OrgTransaction {
  id               String               @id @default(cuid())
  organizationId   String
  officeId         String?
  listingId        String?
  agentProfileId   String?
  status           OrgTransactionStatus @default(PRE_CONTRACT)
  contractSignedAt DateTime?
  inspectionDate   DateTime?
  financingDate    DateTime?
  closingDate      DateTime?
  buyerName        String?
  sellerName       String?
  isCompliant      Boolean              @default(true)
  requiresAction   Boolean              @default(false)
  complianceNotes  String?
  createdByUserId  String
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  organization                  Organization                    @relation(fields: [organizationId], references: [id])
  listing                       OrgListing?                     @relation(fields: [listingId], references: [id])
  office                        Office?                         @relation("TransactionsByOffice", fields: [officeId], references: [id])
  agentProfile                  AgentProfile?                   @relation(fields: [agentProfileId], references: [id])
  createdByUser                 User                            @relation(fields: [createdByUserId], references: [id])
  documents                     OrgTransactionDocument[]
  files                         OrgFile[]
  contractInstances             ContractInstance[]
  workflowTasks                 AgentWorkflowTask[]             @relation("AgentWorkflowTaskTransaction")
  offerIntents                  OfferIntent[]
  rentalLeases                  RentalLease[]
  accountingRecord              TransactionAccountingRecord?
  AiCopilotActionRecommendation AiCopilotActionRecommendation[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, closingDate])
}

model OrgTransactionDocument {
  id            String                     @id @default(cuid())
  transactionId String
  orgFileId     String
  type          OrgTransactionDocumentType @default(OTHER)
  createdAt     DateTime                   @default(now())

  transaction OrgTransaction @relation(fields: [transactionId], references: [id])
  orgFile     OrgFile        @relation("OrgTransactionDocument_File", fields: [orgFileId], references: [id])

  @@index([transactionId])
}

model ContractTemplate {
  id             String                  @id @default(cuid())
  organizationId String
  name           String
  code           String
  description    String?
  jurisdiction   String?
  propertyType   String?
  side           String?
  s3Key          String
  version        Int                     @default(1)
  isActive       Boolean                 @default(true)
  editableKeys   Json?
  tags           String[]                @db.Text @default([])
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  organization   Organization            @relation(fields: [organizationId], references: [id])
  fieldMappings  ContractFieldMapping[]
  instances      ContractInstance[]

  @@index([organizationId, isActive])
  @@index([organizationId, propertyType, side, jurisdiction])
}

model ContractFieldMapping {
  id               String                 @id @default(cuid())
  templateId       String
  templateFieldKey String
  sourceType       ContractFieldSourceType
  sourcePath       String
  defaultValue     String?
  required         Boolean                @default(false)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  template ContractTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model ContractInstance {
  id                   String                  @id @default(cuid())
  organizationId       String
  templateId           String?
  orgListingId         String?
  orgTransactionId     String?
  createdByUserId      String
  title                String
  status               ContractInstanceStatus  @default(DRAFT)
  draftS3Key           String?
  signedS3Key          String?
  fieldValues          Json
  recommendationReason String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id])
  template     ContractTemplate?   @relation(fields: [templateId], references: [id])
  listing      OrgListing?         @relation(fields: [orgListingId], references: [id])
  transaction  OrgTransaction?     @relation(fields: [orgTransactionId], references: [id])
  createdBy    User                @relation(fields: [createdByUserId], references: [id])
  envelope     SignatureEnvelope?

  @@index([organizationId, status])
  @@index([organizationId, orgListingId])
  @@index([organizationId, orgTransactionId])
}

model SignatureEnvelope {
  id                 String                   @id @default(cuid())
  contractInstanceId String                   @unique
  provider           String
  providerEnvelopeId String
  status             SignatureEnvelopeStatus  @default(CREATED)
  signers            Json?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  contractInstance ContractInstance @relation(fields: [contractInstanceId], references: [id], onDelete: Cascade)

  @@index([provider, providerEnvelopeId])
}

model OrgConversation {
  id              String                @id @default(cuid())
  organizationId  String
  tenantId        String?
  type            OrgConversationType
  name            String?
  visibility      OrgChannelVisibility? @default(ORG_WIDE)
  createdByUserId String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  organization  Organization                 @relation(fields: [organizationId], references: [id])
  createdByUser User                         @relation("OrgConversationCreatedBy", fields: [createdByUserId], references: [id])
  participants  OrgConversationParticipant[]
  messages      OrgMessage[]
  offerIntents  OfferIntent[]

  @@index([organizationId, type])
}

model OrgConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  joinedAt       DateTime  @default(now())

  conversation OrgConversation @relation(fields: [conversationId], references: [id])
  user         User            @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@index([userId])
}

model OrgMessage {
  id             String   @id @default(cuid())
  organizationId String
  conversationId String
  senderId       String
  content        String
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization           @relation(fields: [organizationId], references: [id])
  conversation OrgConversation        @relation(fields: [conversationId], references: [id])
  sender       User                   @relation(fields: [senderId], references: [id])
  attachments  OrgMessageAttachment[]

  @@index([organizationId, conversationId, createdAt])
  @@index([organizationId, createdAt])
}

model OrgMessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  fileId    String
  createdAt DateTime @default(now())

  message OrgMessage @relation(fields: [messageId], references: [id])
  file    FileObject @relation(fields: [fileId], references: [id])

  @@index([messageId])
}

model AgentProfile {
  id               String              @id @default(cuid())
  organizationId   String
  userId           String
  officeId         String?
  teamId           String?
  licenseNumber    String?
  licenseState     String?
  licenseExpiresAt DateTime?
  isCommercial     Boolean             @default(false)
  isResidential    Boolean             @default(true)
  title            String?
  bio              String?
  tags             String?
  metadata         Json?
  isCompliant      Boolean             @default(true)
  requiresAction   Boolean             @default(false)
  riskLevel        AgentRiskLevel      @default(LOW)
  riskScore        Int                 @default(0)
  riskFlags        Json?
  lifecycleStage   AgentLifecycleStage @default(ONBOARDING)
  ceCycleStartAt   DateTime?
  ceCycleEndAt     DateTime?
  ceHoursRequired  Int?
  ceHoursCompleted Int?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  organization     Organization                    @relation(fields: [organizationId], references: [id])
  user             User                            @relation(fields: [userId], references: [id])
  office           Office?                         @relation(fields: [officeId], references: [id])
  team             Team?                           @relation(fields: [teamId], references: [id])
  memberships      AgentMembership[]
  ceRecords        AgentCERecord[]
  trainingProgress AgentTrainingProgress[]
  workflowTasks    AgentWorkflowTask[]
  orgListings      OrgListing[]
  orgTransactions  OrgTransaction[]
  leads            Lead[]
  copilotInsights  AiCopilotInsight[]
  copilotActions   AiCopilotActionRecommendation[]
  dailyAnalytics   AgentDailyAnalytics[]
  performanceSnapshots AgentPerformanceSnapshot[]

  @@unique([organizationId, userId])
  @@index([organizationId])
}

model AgentMembership {
  id             String                @id @default(cuid())
  agentProfileId String
  type           AgentMembershipType
  name           String
  externalId     String?
  status         AgentMembershipStatus @default(ACTIVE)
  startedAt      DateTime?
  expiresAt      DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  agentProfile AgentProfile @relation(fields: [agentProfileId], references: [id])

  @@index([agentProfileId, type])
}

model AgentCERecord {
  id             String   @id @default(cuid())
  agentProfileId String
  provider       String?
  courseName     String
  hours          Int
  completedAt    DateTime
  certificateUrl String?
  createdAt      DateTime @default(now())

  agentProfile AgentProfile @relation(fields: [agentProfileId], references: [id])
}

model AgentTrainingModule {
  id               String   @id @default(cuid())
  organizationId   String
  title            String
  description      String?
  orgFileId        String?
  externalUrl      String?
  required         Boolean  @default(false)
  estimatedMinutes Int?
  createdByUserId  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization          Organization              @relation(fields: [organizationId], references: [id])
  createdByUser         User                      @relation(fields: [createdByUserId], references: [id])
  orgFile               OrgFile?                  @relation(fields: [orgFileId], references: [id])
  progress              AgentTrainingProgress[]
  workflowTemplateTasks OrgWorkflowTemplateTask[] @relation("OrgWorkflowTemplateTaskTrainingModule")
}

model AgentTrainingProgress {
  id             String              @id @default(cuid())
  agentProfileId String
  moduleId       String
  status         AgentTrainingStatus @default(NOT_STARTED)
  score          Int?
  completedAt    DateTime?
  notes          String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  agentProfile AgentProfile        @relation(fields: [agentProfileId], references: [id])
  module       AgentTrainingModule @relation(fields: [moduleId], references: [id])

  @@unique([agentProfileId, moduleId])
}

model OrgWorkflowTemplate {
  id              String       @id @default(cuid())
  organizationId  String
  type            WorkflowType
  name            String
  description     String?
  isDefault       Boolean      @default(false)
  createdByUserId String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  organization       Organization              @relation(fields: [organizationId], references: [id])
  createdByUser      User                      @relation("OrgWorkflowTemplateCreatedBy", fields: [createdByUserId], references: [id])
  tasks              OrgWorkflowTemplateTask[]
  agentWorkflowTasks AgentWorkflowTask[]

  @@index([organizationId, type])
}

model OrgWorkflowTemplateTask {
  id               String   @id @default(cuid())
  templateId       String
  title            String
  description      String?
  assignedToRole   String?
  trainingModuleId String?
  orgFileId        String?
  orderIndex       Int      @default(0)
  createdAt        DateTime @default(now())

  template           OrgWorkflowTemplate  @relation(fields: [templateId], references: [id])
  trainingModule     AgentTrainingModule? @relation("OrgWorkflowTemplateTaskTrainingModule", fields: [trainingModuleId], references: [id])
  orgFile            OrgFile?             @relation("OrgWorkflowTemplateTaskFile", fields: [orgFileId], references: [id])
  agentWorkflowTasks AgentWorkflowTask[]

  @@index([templateId])
}

model AgentWorkflowTask {
  id                String              @id @default(cuid())
  organizationId    String
  officeId          String?
  agentProfileId    String
  templateId        String?
  templateTaskId    String?
  type              WorkflowType
  title             String
  description       String?
  assignedToRole    String?
  status            WorkflowTaskStatus  @default(PENDING)
  trigger           WorkflowTaskTrigger @default(MANUAL)
  triggerSource     String?
  listingId         String?
  transactionId     String?
  dueAt             DateTime?
  completedAt       DateTime?
  completedByUserId String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  organization    Organization             @relation(fields: [organizationId], references: [id])
  agentProfile    AgentProfile             @relation(fields: [agentProfileId], references: [id])
  template        OrgWorkflowTemplate?     @relation(fields: [templateId], references: [id])
  templateTask    OrgWorkflowTemplateTask? @relation(fields: [templateTaskId], references: [id])
  completedByUser User?                    @relation("AgentWorkflowTaskCompletedBy", fields: [completedByUserId], references: [id])
  listing         OrgListing?              @relation("AgentWorkflowTaskListing", fields: [listingId], references: [id])
  transaction     OrgTransaction?          @relation("AgentWorkflowTaskTransaction", fields: [transactionId], references: [id])

  @@index([organizationId, agentProfileId, type])
  @@index([organizationId, type, status])
}

model OfferIntent {
  id              String            @id @default(cuid())
  organizationId  String
  listingId       String
  leadId          String?
  consumerId      String?
  status          OfferIntentStatus @default(DRAFT)
  offeredPrice    Int?
  financingType   String?
  closingTimeline String?
  contingencies   String?
  comments        String?
  transactionId   String?
  conversationId  String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id])
  listing      OrgListing       @relation(fields: [listingId], references: [id])
  lead         Lead?            @relation(fields: [leadId], references: [id])
  consumer     User?            @relation(fields: [consumerId], references: [id])
  transaction  OrgTransaction?  @relation(fields: [transactionId], references: [id])
  conversation OrgConversation? @relation(fields: [conversationId], references: [id])

  @@index([organizationId, listingId])
  @@index([organizationId, consumerId])
  @@index([organizationId, status])
}

model RentalProperty {
  id             String             @id @default(cuid())
  organizationId String
  listingId      String?
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  postalCode     String
  country        String?
  propertyType   RentalPropertyType @default(SINGLE_FAMILY)
  status         RentalStatus       @default(UNDER_MGMT)
  ownerName      String?
  ownerContact   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  listing      OrgListing?  @relation(fields: [listingId], references: [id])
  units        RentalUnit[]

  @@index([organizationId, status])
}

model RentalUnit {
  id         String           @id @default(cuid())
  propertyId String
  name       String?
  bedrooms   Int?
  bathrooms  Float?
  squareFeet Int?
  status     RentalUnitStatus @default(VACANT)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  property RentalProperty @relation(fields: [propertyId], references: [id])
  leases   RentalLease[]

  @@index([propertyId, status])
}

model RentalLease {
  id                String            @id @default(cuid())
  organizationId    String
  officeId          String?
  unitId            String
  tenancyType       RentalTenancyType @default(SEASONAL)
  tenantName        String
  tenantContact     String?
  startDate         DateTime
  endDate           DateTime
  rentAmount        Int?
  transactionId     String?
  requiresTaxFiling Boolean           @default(false)
  isCompliant       Boolean           @default(true)
  complianceNotes   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  organization                  Organization                    @relation(fields: [organizationId], references: [id])
  office                        Office?                         @relation("RentalsByOffice", fields: [officeId], references: [id])
  unit                          RentalUnit                      @relation(fields: [unitId], references: [id])
  transaction                   OrgTransaction?                 @relation(fields: [transactionId], references: [id])
  taxSchedule                   RentalTaxSchedule[]
  files                         OrgFile[]
  accountingRecord              RentalLeaseAccountingRecord?
  AiCopilotActionRecommendation AiCopilotActionRecommendation[]

  @@index([organizationId, unitId])
  @@index([organizationId, endDate])
}

model RentalTaxSchedule {
  id          String          @id @default(cuid())
  leaseId     String
  periodLabel String
  dueDate     DateTime
  amountDue   Int?
  status      RentalTaxStatus @default(PENDING)
  paidDate    DateTime?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  lease RentalLease @relation(fields: [leaseId], references: [id])

  @@index([leaseId, status, dueDate])
}

model MlsFeedConfig {
  id                    String      @id @default(cuid())
  organizationId        String      @unique
  provider              MlsProvider @default(GENERIC)
  officeCode            String?
  brokerId              String?
  boardName             String?
  boardUrl              String?
  enabled               Boolean     @default(true)
  lastFullSyncAt        DateTime?
  lastIncrementalSyncAt DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}

model MlsSyncRun {
  id             String        @id @default(cuid())
  organizationId String
  provider       MlsProvider
  startedAt      DateTime      @default(now())
  finishedAt     DateTime?
  status         MlsSyncStatus @default(PENDING)
  totalFetched   Int           @default(0)
  totalUpserted  Int           @default(0)
  totalFailed    Int           @default(0)
  errorMessage   String?
  createdAt      DateTime      @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, startedAt])
}

model ListingSearchIndex {
  id             String       @id @default(cuid())
  organizationId String
  listingId      String?
  mlsNumber      String?
  mlsProvider    MlsProvider?
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  postalCode     String
  country        String?
  propertyType   String?
  listPrice      Int?
  bedrooms       Int?
  bathrooms      Float?
  squareFeet     Int?
  isActive       Boolean      @default(true)
  isRental       Boolean      @default(false)
  searchText     String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id])
  listing       Listing?       @relation(fields: [listingId], references: [id])
  savedListings SavedListing[]

  @@unique([organizationId, mlsNumber])
  @@index([organizationId, isActive])
  @@index([organizationId, isActive, isRental])
  @@index([organizationId, city])
  @@index([organizationId, state])
  @@index([organizationId, postalCode])
}

model SavedListing {
  id             String   @id @default(cuid())
  organizationId String
  consumerId     String
  searchIndexId  String
  createdAt      DateTime @default(now())

  organization Organization       @relation(fields: [organizationId], references: [id])
  consumer     User               @relation(fields: [consumerId], references: [id])
  searchIndex  ListingSearchIndex @relation(fields: [searchIndexId], references: [id])

  @@unique([consumerId, searchIndexId])
  @@index([organizationId, consumerId])
}

model SavedSearch {
  id             String               @id @default(cuid())
  organizationId String
  consumerId     String
  name           String
  criteria       Json
  alertsEnabled  Boolean              @default(true)
  frequency      SavedSearchFrequency @default(INSTANT)
  lastRunAt      DateTime?
  lastNotifiedAt DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  organization Organization            @relation(fields: [organizationId], references: [id])
  consumer     User                    @relation(fields: [consumerId], references: [id])
  alertEvents  SavedSearchAlertEvent[]

  @@index([organizationId, consumerId])
  @@index([organizationId, frequency, alertsEnabled])
}

model SavedSearchAlertEvent {
  id            String   @id @default(cuid())
  savedSearchId String
  matchCount    Int
  sentAt        DateTime @default(now())
  channel       String   @default("email")
  createdAt     DateTime @default(now())

  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id])

  @@index([savedSearchId, sentAt])
}

model AiCopilotInsight {
  id             String               @id @default(cuid())
  organizationId String
  agentProfileId String
  type           AiCopilotInsightType @default(DAILY_BRIEFING)
  title          String
  summary        String
  data           Json
  createdAt      DateTime             @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  agentProfile AgentProfile @relation(fields: [agentProfileId], references: [id])

  @@index([organizationId, agentProfileId, type, createdAt])
}

model AiCopilotActionRecommendation {
  id                String                @id @default(cuid())
  organizationId    String
  agentProfileId    String
  leadId            String?
  orgListingId      String?
  orgTransactionId  String?
  leaseId           String?
  title             String
  description       String?
  status            AiCopilotActionStatus @default(SUGGESTED)
  priority          Int?
  metadata          Json?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  completedAt       DateTime?
  completedByUserId String?

  organization Organization    @relation(fields: [organizationId], references: [id])
  agentProfile AgentProfile    @relation(fields: [agentProfileId], references: [id])
  lead         Lead?           @relation(fields: [leadId], references: [id])
  listing      OrgListing?     @relation(fields: [orgListingId], references: [id])
  transaction  OrgTransaction? @relation(fields: [orgTransactionId], references: [id])
  rentalLease  RentalLease?    @relation(fields: [leaseId], references: [id])
  completedBy  User?           @relation("AiCopilotActionCompletedBy", fields: [completedByUserId], references: [id])

  @@index([organizationId, agentProfileId, status])
  @@index([leadId])
  @@index([orgListingId])
  @@index([orgTransactionId])
  @@index([leaseId])
}

model AccountingIntegrationConfig {
  id             String             @id @default(cuid())
  organizationId String             @unique
  provider       AccountingProvider @default(QUICKBOOKS)
  realmId        String?
  connectedAt    DateTime?
  lastSyncAt     DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}

model TransactionAccountingRecord {
  id             String               @id @default(cuid())
  organizationId String
  transactionId  String               @unique
  provider       AccountingProvider   @default(QUICKBOOKS)
  externalId     String?
  syncStatus     AccountingSyncStatus @default(PENDING)
  lastSyncAt     DateTime?
  errorMessage   String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id])
  transaction  OrgTransaction @relation(fields: [transactionId], references: [id])

  @@index([organizationId, provider, syncStatus])
}

model RentalLeaseAccountingRecord {
  id             String               @id @default(cuid())
  organizationId String
  leaseId        String               @unique
  provider       AccountingProvider   @default(QUICKBOOKS)
  externalId     String?
  syncStatus     AccountingSyncStatus @default(PENDING)
  lastSyncAt     DateTime?
  errorMessage   String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  lease        RentalLease  @relation(fields: [leaseId], references: [id])

  @@index([organizationId, provider, syncStatus])
}

model QuickBooksConnection {
  id        String   @id @default(cuid())
  orgId     String   @unique
  realmId   String
  tokensJson String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Lead {
  id              String     @id @default(cuid())
  organizationId  String
  officeId        String?
  consumerId      String?
  listingId       String?
  agentProfileId  String?
  status          LeadStatus @default(NEW)
  source          LeadSource @default(PORTAL_SIGNUP)
  name            String?
  email           String?
  phone           String?
  message         String?
  desiredMoveIn   DateTime?
  budgetMin       Int?
  budgetMax       Int?
  bedrooms        Int?
  bathrooms       Float?
  aiScore             Float?
  conversionLikelihood Float?
  lastAiScoreAt       DateTime?
  createdByUserId String?
  conversationId  String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  organization                  Organization                    @relation(fields: [organizationId], references: [id])
  office                        Office?                         @relation("LeadsByOffice", fields: [officeId], references: [id])
  consumer                      User?                           @relation("Lead_Consumer", fields: [consumerId], references: [id])
  listing                       OrgListing?                     @relation(fields: [listingId], references: [id])
  agentProfile                  AgentProfile?                   @relation(fields: [agentProfileId], references: [id])
  createdByUser                 User?                           @relation("Lead_CreatedBy", fields: [createdByUserId], references: [id])
  offerIntents                  OfferIntent[]
  AiCopilotActionRecommendation AiCopilotActionRecommendation[]
  scoreHistory                  LeadScoreHistory[]

  @@index([organizationId, status])
  @@index([organizationId, agentProfileId])
}

model LeadScoreHistory {
  id             String   @id @default(cuid())
  organizationId String
  leadId         String

  aiScore       Float
  likelihood    Float
  reasonSummary String?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])

  @@index([organizationId, leadId, createdAt])
}

enum OrgFileCategory {
  CONTRACT_TEMPLATE
  COMPLIANCE
  TRAINING
  MARKETING
  RENTAL_PM
  OTHER
}

enum DocumentType {
  UNKNOWN
  LISTING_CONTRACT
  PURCHASE_CONTRACT
  LOI
  ADDENDUM
  DISCLOSURE
  INSPECTION
  PROOF_OF_FUNDS
  CLOSING_DOC
  RENTAL_AGREEMENT
  TAX_DOC
}

enum DocumentReviewStatus {
  NONE
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
}

enum ComplianceStatus {
  UNKNOWN
  PENDING
  PASSED
  FAILED
  NEEDS_REVIEW
}

enum PlaybookTriggerType {
  LEAD_CREATED
  LEAD_UPDATED
  LEAD_SCORE_UPDATED
  LEAD_CONVERSION_HIGH
  LEAD_CONVERSION_LOW
  LISTING_CREATED
  LISTING_UPDATED
  DOCUMENT_EVALUATED
  TRANSACTION_UPDATED
  RENTAL_UPDATED
  MLS_SYNC_COMPLETED
  ACCOUNTING_SYNC_FAILED
  AGENT_NONCOMPLIANT
}

enum PlaybookActionType {
  CREATE_TASK
  SEND_NOTIFICATION
  SEND_EMAIL
  ASSIGN_LEAD
  FLAG_ENTITY
  START_PLAYBOOK
  UPDATE_ENTITY_STATUS
  RUN_AI_PERSONA
}

model DripCampaign {
  id             String      @id @default(cuid())
  organizationId String
  name           String
  description    String?
  enabled        Boolean     @default(true)
  steps          DripStep[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, enabled])
}

model DripStep {
  id         String       @id @default(cuid())
  campaign   DripCampaign @relation(fields: [campaignId], references: [id])
  campaignId String

  offsetHours Int
  actionType  String
  payload     Json?

  createdAt DateTime @default(now())

  @@index([campaignId])
}

model RevenueForecast {
  id             String   @id @default(cuid())
  organizationId String

  forecast30Days Float
  forecast60Days Float
  forecast90Days Float

  totalPending Float
  totalActive  Float
  totalLost    Float

  assumptions Json?
  createdAt   DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt])
}

enum AnalyticsGranularity {
  DAILY
}

model OrgFolder {
  id              String   @id @default(uuid())
  orgId           String
  tenantId        String?
  name            String
  parentId        String?
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  org           Organization @relation(fields: [orgId], references: [id])
  parent        OrgFolder?   @relation("OrgFolder_Parent", fields: [parentId], references: [id])
  children      OrgFolder[]  @relation("OrgFolder_Parent")
  files         OrgFile[]
  createdByUser User         @relation("OrgFolderCreatedBy", fields: [createdByUserId], references: [id])

  @@index([orgId, parentId])
}

model OrgFile {
  id               String          @id @default(uuid())
  orgId            String
  tenantId         String?
  folderId         String?
  name             String
  description      String?
  category         OrgFileCategory @default(OTHER)
  documentType     DocumentType     @default(UNKNOWN)
  complianceStatus ComplianceStatus @default(UNKNOWN)
  reviewStatus     DocumentReviewStatus @default(NONE)
  fileId           String
  uploadedByUserId String
  listingId        String?
  transactionId    String?
  leaseId          String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  org                   Organization              @relation(fields: [orgId], references: [id])
  folder                OrgFolder?                @relation(fields: [folderId], references: [id])
  file                  FileObject                @relation(fields: [fileId], references: [id])
  uploadedByUser        User                      @relation(fields: [uploadedByUserId], references: [id])
  listing               OrgListing?               @relation(fields: [listingId], references: [id])
  transaction           OrgTransaction?           @relation(fields: [transactionId], references: [id])
  lease                 RentalLease?              @relation(fields: [leaseId], references: [id])
  trainingModules       AgentTrainingModule[]
  listingDocuments      OrgListingDocument[]      @relation("OrgListingDocument_File")
  transactionDocuments  OrgTransactionDocument[]  @relation("OrgTransactionDocument_File")
  workflowTemplateTasks OrgWorkflowTemplateTask[] @relation("OrgWorkflowTemplateTaskFile")
  knowledgeDocuments    KnowledgeDocument[]
  versions             OrgFileVersion[]
  comments             OrgFileComment[]

  @@index([orgId, folderId])
  @@index([orgId, category])
  @@index([orgId, complianceStatus])
  @@index([listingId])
  @@index([transactionId])
  @@index([leaseId])
}

model OrgFileVersion {
  id            String   @id @default(cuid())
  orgFile       OrgFile  @relation(fields: [orgFileId], references: [id])
  orgFileId     String

  versionNumber Int
  storageKey    String
  createdAt     DateTime @default(now())
  createdById   String?
  createdBy     User?    @relation(fields: [createdById], references: [id])

  @@unique([orgFileId, versionNumber])
}

model KnowledgeDocument {
  id             String   @id @default(cuid())
  organizationId String
  orgFileId      String?
  title          String
  s3Key          String
  source         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  orgFile      OrgFile?     @relation(fields: [orgFileId], references: [id])

  @@index([organizationId, source])
}

model OrgFileComment {
  id             String   @id @default(cuid())
  orgFile        OrgFile  @relation(fields: [orgFileId], references: [id])
  orgFileId      String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  user           User    @relation(fields: [userId], references: [id])
  userId         String

  content        String
  pageNumber     Int?
  x              Float?
  y              Float?
  width          Float?
  height         Float?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([orgFileId])
}

model AgentPerformanceSnapshot {
  id                  String   @id @default(cuid())
  organizationId      String
  agentProfileId      String

  leadsWorked         Int      @default(0)
  leadsConverted      Int      @default(0)
  avgResponseTimeSec  Int      @default(0)
  tasksCompleted      Int      @default(0)
  tasksOverdue        Int      @default(0)
  documentsIssues     Int      @default(0)
  compliantDocs       Int      @default(0)
  listingsActive      Int      @default(0)
  transactionsActive  Int      @default(0)
  activityScore       Float    @default(0)
  performanceScore    Float    @default(0)
  responsivenessScore Float    @default(0)

  periodStart         DateTime
  periodEnd           DateTime

  createdAt           DateTime @default(now())

  organization        Organization @relation(fields: [organizationId], references: [id])
  agentProfile        AgentProfile @relation(fields: [agentProfileId], references: [id])

  @@index([organizationId, agentProfileId, periodStart])
}

model SearchVector {
  id             String   @id @default(cuid())
  organizationId String
  entityType     String
  entityId       String
  embedding      Float[]
  content        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, entityType])
  @@unique([organizationId, entityType, entityId])
}

model LivePresence {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  location       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId, location])
}

model AiInsight {
  id             String      @id @default(cuid())
  organizationId String
  type           InsightType
  targetId       String?
  summary        String
  details        Json?
  createdAt      DateTime    @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, type])
  @@index([organizationId, targetId])
}

model Playbook {
  id             String           @id @default(cuid())
  organizationId String
  name           String
  description    String?
  enabled        Boolean          @default(true)

  organization   Organization     @relation(fields: [organizationId], references: [id])
  triggers       PlaybookTrigger[] @relation("PlaybookTriggers")
  actions        PlaybookAction[]  @relation("PlaybookActions")
  runs           PlaybookRun[]

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([organizationId, enabled])
}

model PlaybookTrigger {
  id          String               @id @default(cuid())
  playbookId  String
  type        PlaybookTriggerType
  conditions  Json?

  playbook    Playbook             @relation("PlaybookTriggers", fields: [playbookId], references: [id])
}

model PlaybookAction {
  id          String               @id @default(cuid())
  playbookId  String
  type        PlaybookActionType
  params      Json?

  playbook    Playbook             @relation("PlaybookActions", fields: [playbookId], references: [id])
}

model PlaybookRun {
  id             String              @id @default(cuid())
  playbookId     String
  organizationId String
  triggerType    PlaybookTriggerType
  actionSummary  String?
  success        Boolean             @default(true)
  errorMessage   String?
  listingId      String?
  leadId         String?
  transactionId  String?
  leaseId        String?
  startedAt      DateTime            @default(now())
  finishedAt     DateTime?

  playbook       Playbook            @relation(fields: [playbookId], references: [id])

  @@index([organizationId, playbookId, startedAt])
  @@index([organizationId, listingId])
  @@index([organizationId, leadId])
  @@index([organizationId, transactionId])
  @@index([organizationId, leaseId])
}

model OrgEvent {
  id             String       @id @default(cuid())
  organizationId String
  tenantId       String?
  actorId        String?
  type           OrgEventType
  message        String?
  payload        Json?
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  actor        User?        @relation("OrgEvent_actor", fields: [actorId], references: [id])

  @@index([organizationId, createdAt])
  @@index([actorId, createdAt])
  @@index([type, organizationId])
}

model AgentInvite {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  email String
  token String @unique

  status AgentInviteStatus @default(PENDING)

  invitedByUserId String
  invitedByUser   User   @relation("AgentInvitesInvitedBy", fields: [invitedByUserId], references: [id])

  acceptedByUserId String?
  acceptedByUser   User?   @relation("AgentInvitesAcceptedBy", fields: [acceptedByUserId], references: [id])

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
}

model Team {
  id          String           @id @default(cuid())
  tenantId    String
  orgId       String
  name        String
  officeId    String?
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  org         Organization     @relation(fields: [orgId], references: [id])
  office      Office?          @relation(fields: [officeId], references: [id])
  members     TeamMembership[]
  assignedUsers User[]         @relation("TeamMembers")
  assignments Assignment[]
  savedViews  SavedView[]
  agentProfiles AgentProfile[]

  @@index([orgId])
}

model TeamMembership {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model TeamMember {
  id                String        @id @default(uuid()) @map("id") @db.Uuid
  tenantId          String        @map("tenant_id")
  orgId             String?       @map("org_id")
  name              String        @map("name")
  email             String        @map("email")
  phone             String?       @map("phone")
  role              String        @default("Agent") @map("role")
  status            String        @default("active") @map("status")
  experienceYears   Int?          @map("experience_years")
  rating            Float         @default(0) @map("rating")
  totalSales        Int           @default(0) @map("total_sales")
  dealsInProgress   Int           @default(0) @map("deals_in_progress")
  openLeads         Int           @default(0) @map("open_leads")
  responseTimeHours Float         @default(0) @map("response_time_hours")
  joinedAt          DateTime      @default(now()) @map("joined_at")
  lastActiveAt      DateTime      @default(now()) @map("last_active_at")
  notes             String?       @map("notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  organization      Organization? @relation(fields: [orgId], references: [id])

  @@index([tenantId])
  @@index([orgId])
  @@map("team_members")
}

model DelegatedAccess {
  id                    String   @id @default(cuid())
  organizationId        String
  agentId               String
  assistantId           String
  canManageListings     Boolean  @default(true)
  canManageLeads        Boolean  @default(true)
  canManageTransactions Boolean  @default(true)
  canManageRentals      Boolean  @default(true)
  canManageTasks        Boolean  @default(true)
  canViewFinancials     Boolean  @default(false)
  canChangeCompliance   Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  agent        User          @relation("AgentDelegations", fields: [agentId], references: [id])
  assistant    User          @relation("AssistantDelegations", fields: [assistantId], references: [id])

  @@index([organizationId, agentId])
  @@index([organizationId, assistantId])
}

model Person {
  id                      String                    @id @default(cuid())
  tenantId                String
  organizationId          String
  ownerId                 String?
  firstName               String
  lastName                String
  primaryEmail            String?
  secondaryEmails         String[]                  @default([])
  primaryPhone            String?
  secondaryPhones         String[]                  @default([])
  stage                   PersonStage               @default(NEW)
  tags                    String[]                  @default([])
  source                  String?
  companyId               String?
  householdId             String?
  householdRole           String?
  utmSource               String?
  utmMedium               String?
  utmCampaign             String?
  gclid                   String?
  address                 String?
  leadScore               Float?
  buyerRepStatus          BuyerRepStatus            @default(NONE)
  doNotContact            Boolean                   @default(false)
  lastActivityAt          DateTime?
  preferredChannels       ConsentChannel[]          @default([])
  deletedAt               DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  pipelineId              String?
  stageId                 String?
  stageEnteredAt          DateTime?
  scoreTier               LeadScoreTier             @default(D)
  scoreUpdatedAt          DateTime?
  tenant                  Tenant                    @relation(fields: [tenantId], references: [id])
  organization            Organization              @relation(fields: [organizationId], references: [id])
  owner                   User?                     @relation("PersonOwner", fields: [ownerId], references: [id])
  company                 Company?                  @relation("CompanyContacts", fields: [companyId], references: [id])
  household               Household?                @relation("HouseholdMembers", fields: [householdId], references: [id])
  consents                Consent[]
  listings                Listing[]                 @relation("PersonListings")
  tours                   Tour[]
  agreements              Agreement[]
  deals                   Deal[]
  offers                  Offer[]
  messages                Message[]
  conversations           Conversation[]            @relation("PersonConversations")
  conversationMemberships ConversationParticipant[] @relation("ConversationParticipantPerson")
  activities              Activity[]
  assignments             Assignment[]
  documents               PersonDocument[]
  communicationBlocks     CommunicationBlock[]
  quietHourOverrides      QuietHourOverride[]
  routingLogs             RoutingLog[]
  calendarEvents          CalendarEvent[]
  mergeProposals          ContactMergeProposal[]    @relation("PersonMergeProposals")
  pipeline                Pipeline?                 @relation("PipelinePersons", fields: [pipelineId], references: [id])
  pipelineStage           Stage?                    @relation("StagePersons", fields: [stageId], references: [id])
  leadFit                 LeadFit?
  activityRollup          LeadActivityRollup?
  leadNotes               LeadNote[]
  leadTasks               LeadTask[]
  siteEvents              Event[]
  touchpoints             LeadTouchpoint[]
  timeline                LeadHistory[]
  consentEvents           ConsentEvent[]
  messageTouchpoints      Touchpoint[]              @relation("TouchpointPerson")
  cases                   Case[]                    @relation("CaseContact")
  primaryForCompanies     Company[]                 @relation("CompanyPrimaryContact")
  sequenceEnrollments     SequenceEnrollment[]
  leadSequenceEnrollments LeadSequenceEnrollment[]
  emailDrafts             EmailDraft[]
  campaignEnrollments     CampaignEnrollment[]
  queueAssignments        QueueAssignment[]         @relation("QueueAssignmentPerson")
  customFieldValues       CustomFieldValue[]
  JourneySimulation       JourneySimulation[]
  leadScoreV2             LeadScoreV2?

  @@unique([tenantId, primaryEmail])
  @@unique([tenantId, primaryPhone])
  @@index([tenantId, deletedAt])
  @@index([tenantId, pipelineId])
  @@index([tenantId, stageId])
  @@index([tenantId, companyId])
  @@index([tenantId, householdId])
}

model Company {
  id               String       @id @default(cuid())
  tenantId         String
  organizationId   String
  ownerId          String?
  name             String
  legalName        String?
  industry         String?
  type             String?
  website          String?
  phone            String?
  email            String?
  tags             String[]     @default([])
  source           String?
  size             String?
  primaryContactId String?
  billingAddress   String?
  shippingAddress  String?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  tenant           Tenant       @relation(fields: [tenantId], references: [id])
  organization     Organization @relation(fields: [organizationId], references: [id])
  owner            User?        @relation("CompanyOwner", fields: [ownerId], references: [id])
  primaryContact   Person?      @relation("CompanyPrimaryContact", fields: [primaryContactId], references: [id])
  contacts         Person[]     @relation("CompanyContacts")
  deals            Deal[]

  @@index([tenantId, name])
  @@index([tenantId, ownerId])
  @@index([tenantId, primaryContactId])
}

model Household {
  id             String       @id @default(cuid())
  tenantId       String
  organizationId String
  ownerId        String?
  name           String?
  timezone       String?
  tags           String[]     @default([])
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  tenant         Tenant       @relation(fields: [tenantId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  owner          User?        @relation("HouseholdOwner", fields: [ownerId], references: [id])
  members        Person[]     @relation("HouseholdMembers")

  @@index([tenantId, ownerId])
}

/// contact_list_view is managed via migrations as a materialized view

model Pipeline {
  id          String               @id @default(cuid())
  tenantId    String
  brokerageId String?
  familyId    String               @default(cuid())
  name        String
  type        String
  useCase     String?
  isDefault   Boolean              @default(false)
  status      PipelineStatus       @default(DRAFT)
  version     Int                  @default(1)
  order       Int                  @default(0)
  publishedAt DateTime?
  archivedAt  DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  tenant      Tenant               @relation(fields: [tenantId], references: [id])
  stages      Stage[]
  fieldSets   FieldSet[]
  automations PipelineAutomation[]
  leads       Person[]             @relation("PipelinePersons")

  @@unique([tenantId, name])
  @@unique([tenantId, familyId, version])
  @@index([tenantId])
  @@index([tenantId, isDefault])
}

model Stage {
  id          String   @id @default(cuid())
  tenantId    String
  pipelineId  String
  name        String
  order       Int
  probWin     Int?
  slaMinutes  Int?
  slaHours    Int?
  exitReasons Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id])
  leads       Person[] @relation("StagePersons")

  @@unique([tenantId, pipelineId, name])
  @@index([tenantId])
  @@index([tenantId, pipelineId])
  @@index([tenantId, pipelineId, order])
}

model FieldSet {
  id         String   @id @default(cuid())
  tenantId   String
  pipelineId String
  target     String
  schema     Json
  uiSchema   Json?
  visibility Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, pipelineId])
}

model PipelineAutomation {
  id         String   @id @default(cuid())
  tenantId   String
  pipelineId String
  name       String?
  trigger    Json
  actions    Json
  isEnabled  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, pipelineId])
  @@index([tenantId, isEnabled])
}

model LeadFit {
  id             String   @id @default(cuid())
  tenantId       String
  personId       String   @unique
  preapproved    Boolean  @default(false)
  budgetMin      Int?
  budgetMax      Int?
  timeframeDays  Int?
  geo            String?
  inventoryMatch Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  person         Person   @relation(fields: [personId], references: [id])

  @@index([tenantId])
}

model Event {
  id          String   @id @default(cuid())
  tenantId    String
  personId    String?
  anonymousId String?
  name        String
  timestamp   DateTime
  properties  Json?
  context     Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  person      Person?  @relation(fields: [personId], references: [id])

  @@index([tenantId])
  @@index([tenantId, personId])
  @@index([tenantId, name, timestamp])
}

model LeadActivityRollup {
  id                 String    @id @default(cuid())
  tenantId           String
  personId           String    @unique
  last7dListingViews Int       @default(0)
  last7dSessions     Int       @default(0)
  lastReplyAt        DateTime?
  lastEmailOpenAt    DateTime?
  lastTouchpointAt   DateTime?
  updatedAt          DateTime  @updatedAt
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  person             Person    @relation(fields: [personId], references: [id])

  @@index([tenantId])
}

model LeadNote {
  id        String   @id @default(cuid())
  tenantId  String
  personId  String
  userId    String
  body      String
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  person    Person   @relation(fields: [personId], references: [id])
  author    User     @relation("LeadNoteAuthor", fields: [userId], references: [id])

  @@index([tenantId, personId])
}

model LeadTouchpoint {
  id         String             @id @default(cuid())
  tenantId   String
  personId   String
  userId     String?
  type       LeadTouchpointType
  channel    MessageChannel?
  occurredAt DateTime
  summary    String?
  body       String?
  metadata   Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  tenant     Tenant             @relation(fields: [tenantId], references: [id])
  person     Person             @relation(fields: [personId], references: [id])
  user       User?              @relation(fields: [userId], references: [id])

  @@index([tenantId, personId, occurredAt])
}

model LeadTask {
  id         String         @id @default(cuid())
  tenantId   String
  personId   String
  assigneeId String?
  title      String
  dueAt      DateTime?
  status     LeadTaskStatus @default(OPEN)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  person     Person         @relation(fields: [personId], references: [id])
  assignee   User?          @relation("LeadTaskAssignee", fields: [assigneeId], references: [id])

  @@index([tenantId, personId])
}

model LeadHistory {
  id         String               @id @default(cuid())
  tenantId   String
  personId   String
  eventType  LeadHistoryEventType
  actorId    String?
  payload    Json?
  occurredAt DateTime             @default(now())
  createdAt  DateTime             @default(now())
  tenant     Tenant               @relation(fields: [tenantId], references: [id])
  person     Person               @relation(fields: [personId], references: [id])
  actor      User?                @relation("LeadHistoryActor", fields: [actorId], references: [id])

  @@index([tenantId, personId, occurredAt])
  @@index([tenantId, actorId])
}

view LeadAnalyticsView {
  tenantId           String
  organizationId     String
  personId           String
  ownerId            String?
  stageId            String?
  pipelineId         String?
  scoreTier          LeadScoreTier?
  stageEnteredAt     DateTime?
  lastActivityAt     DateTime?
  touchpoints1d      Int?
  touchpoints7d      Int?
  touchpoints14d     Int?
  touchpoints30d     Int?
  touchpoints60d     Int?
  firstTouchpointAt  DateTime?
  lastTouchpointAt   DateTime?
  stageMovesTotal    Int?
  stageMovesForward  Int?
  avgStageDurationMs Decimal?       @db.Decimal(18, 4)
  lastStageMoveAt    DateTime?
  lastFromStageId    String?
  lastToStageId      String?
  lastFromStageName  String?
  lastToStageName    String?
  slaBreaches        Int?
  avgResponseMs      Decimal?       @db.Decimal(18, 4)
  bucketStart        DateTime?
  bucketEnd          DateTime?
  stageKey           String?

  @@unique([tenantId, personId])
  @@map("LeadAnalyticsView")
}

model ClientAnalyticsEvent {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  name       String
  category   String?
  properties Json?
  sourceIp   String?
  userAgent  String?
  occurredAt DateTime
  receivedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, occurredAt])
  @@index([tenantId, name])
}

model ConsentEvent {
  id         String         @id @default(cuid())
  tenantId   String
  personId   String
  channel    ConsentChannel
  status     ConsentStatus
  source     String?
  reason     String?
  blocked    Boolean        @default(false)
  metadata   Json?
  actorId    String?
  occurredAt DateTime       @default(now())
  createdAt  DateTime       @default(now())
  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  person     Person         @relation(fields: [personId], references: [id])
  actor      User?          @relation("ConsentEventActor", fields: [actorId], references: [id])

  @@index([tenantId, personId, channel, occurredAt])
  @@index([tenantId, actorId])
}

model Touchpoint {
  id             String           @id @default(cuid())
  tenantId       String
  personId       String
  conversationId String?
  actorId        String?
  direction      MessageDirection
  channel        MessageChannel
  status         MessageStatus    @default(QUEUED)
  subject        String?
  preview        String?
  body           String?
  providerId     String?
  providerMeta   Json?
  sentAt         DateTime?
  deliveredAt    DateTime?
  failedAt       DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  tenant         Tenant           @relation(fields: [tenantId], references: [id])
  person         Person           @relation("TouchpointPerson", fields: [personId], references: [id])
  conversation   Conversation?    @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  actor          User?            @relation("TouchpointActor", fields: [actorId], references: [id])

  @@index([tenantId, personId, createdAt])
  @@index([tenantId, conversationId])
  @@index([tenantId, status])
  @@index([tenantId, actorId])
}

model SavedView {
  id          String         @id @default(cuid())
  tenantId    String
  userId      String
  name        String
  scope       SavedViewScope @default(PRIVATE)
  teamId      String?
  description String?
  columns     Json?
  sort        Json?
  filters     Json
  query       Json?          @map("query")
  isDefault   Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  team   Team?  @relation(fields: [teamId], references: [id])

  @@unique([userId, name])
  @@index([tenantId, scope])
  @@index([tenantId, teamId])
}

model ViewPreset {
  id              String                 @id @default(cuid())
  tenantId        String
  brokerageId     String?
  name            String
  scope           String
  layout          Json
  filters         Json?
  sort            Json?
  roles           String[]               @default([])
  isDefault       Boolean                @default(false)
  description     String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  tenant          Tenant                 @relation(fields: [tenantId], references: [id])
  shareTokens     ViewPresetShareToken[]
  consumerConfigs ConsumerPortalConfig[]

  @@index([tenantId])
  @@index([tenantId, scope])
  @@index([tenantId, isDefault])
}

model ViewPresetShareToken {
  id           String     @id @default(cuid())
  viewPresetId String
  token        String     @unique
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  viewPreset   ViewPreset @relation(fields: [viewPresetId], references: [id], onDelete: Cascade)

  @@index([viewPresetId])
}

model ConsumerPortalConfig {
  id           String      @id @default(cuid())
  tenantId     String
  brokerageId  String?
  modules      Json
  fields       Json?
  viewPresetId String?
  permissions  Json?
  branding     Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  tenant       Tenant      @relation(fields: [tenantId], references: [id])
  viewPreset   ViewPreset? @relation(fields: [viewPresetId], references: [id], onDelete: SetNull)

  @@unique([tenantId])
  @@index([tenantId, viewPresetId])
}

model Sequence {
  id              String               @id @default(cuid())
  tenantId        String
  organizationId  String
  name            String
  description     String?
  tags            String[]             @default([])
  steps           Json
  throttlePerDay  Int?
  quietHoursStart Int?
  quietHoursEnd   Int?
  active          Boolean              @default(true)
  stopOnReply     Boolean              @default(true)
  archivedAt      DateTime?
  createdById     String?
  updatedById     String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id])
  createdBy       User?                @relation("SequenceCreatedBy", fields: [createdById], references: [id])
  updatedBy       User?                @relation("SequenceUpdatedBy", fields: [updatedById], references: [id])
  enrollments     SequenceEnrollment[]
  stepLogs        SequenceStepLog[]

  @@unique([tenantId, name])
  @@index([tenantId, active])
}

model SequenceEnrollment {
  id             String                   @id @default(cuid())
  tenantId       String
  sequenceId     String
  personId       String
  ownerId        String?
  status         SequenceEnrollmentStatus @default(ACTIVE)
  currentStep    Int                      @default(0)
  startedAt      DateTime                 @default(now())
  nextRunAt      DateTime?
  lastExecutedAt DateTime?
  completedAt    DateTime?
  canceledAt     DateTime?
  stopReason     String?
  metadata       Json?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  tenant         Tenant                   @relation(fields: [tenantId], references: [id])
  sequence       Sequence                 @relation(fields: [sequenceId], references: [id])
  person         Person                   @relation(fields: [personId], references: [id])
  owner          User?                    @relation("SequenceEnrollmentOwner", fields: [ownerId], references: [id])
  stepLogs       SequenceStepLog[]

  @@unique([sequenceId, personId])
  @@index([tenantId, sequenceId])
  @@index([tenantId, personId])
  @@index([tenantId, status])
}

model SequenceStepLog {
  id           String             @id @default(cuid())
  tenantId     String
  sequenceId   String
  enrollmentId String
  stepIndex    Int
  stepPayload  Json?
  channel      MessageChannel?
  status       SequenceStepStatus @default(PENDING)
  scheduledFor DateTime?
  executedAt   DateTime?
  completedAt  DateTime?
  canceledAt   DateTime?
  messageId    String?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  sequence     Sequence           @relation(fields: [sequenceId], references: [id])
  enrollment   SequenceEnrollment @relation(fields: [enrollmentId], references: [id])

  @@index([tenantId, sequenceId])
  @@index([tenantId, enrollmentId])
  @@index([tenantId, status])
}

model MessageTemplate {
  id             String          @id @default(cuid())
  tenantId       String
  organizationId String
  name           String
  channel        OutreachChannel
  subject        String?
  body           String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])
  steps          CampaignStep[]

  @@unique([tenantId, name])
  @@index([tenantId, organizationId])
}

model Campaign {
  id             String               @id @default(cuid())
  tenantId       String
  organizationId String
  name           String
  description    String?
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  tenant         Tenant               @relation(fields: [tenantId], references: [id])
  organization   Organization         @relation(fields: [organizationId], references: [id])
  steps          CampaignStep[]
  enrollments    CampaignEnrollment[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
}

model CampaignStep {
  id         String          @id @default(cuid())
  campaignId String
  order      Int
  delayHours Int
  templateId String
  channel    OutreachChannel
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  campaign   Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  template   MessageTemplate @relation(fields: [templateId], references: [id])

  @@unique([campaignId, order])
  @@index([campaignId, templateId])
}

model CampaignEnrollment {
  id             String                   @id @default(cuid())
  tenantId       String
  organizationId String
  campaignId     String
  leadId         String
  status         CampaignEnrollmentStatus @default(ACTIVE)
  startedAt      DateTime                 @default(now())
  lastStepSent   Int?
  nextRunAt      DateTime
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  tenant         Tenant                   @relation(fields: [tenantId], references: [id])
  organization   Organization             @relation(fields: [organizationId], references: [id])
  campaign       Campaign                 @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead           Person                   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  events         OutreachEvent[]

  @@unique([campaignId, leadId])
  @@index([tenantId, status])
  @@index([tenantId, nextRunAt])
  @@index([tenantId, campaignId])
}

model OutreachEvent {
  id             String              @id @default(cuid())
  tenantId       String
  organizationId String
  enrollmentId   String
  stepOrder      Int
  channel        OutreachChannel
  status         OutreachEventStatus @default(QUEUED)
  error          String?
  sentAt         DateTime?
  metadata       Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  tenant         Tenant              @relation(fields: [tenantId], references: [id])
  organization   Organization        @relation(fields: [organizationId], references: [id])
  enrollment     CampaignEnrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([tenantId, organizationId])
  @@index([tenantId, status])
}

model CustomField {
  id             String             @id @default(cuid())
  tenantId       String
  organizationId String
  entity         CustomFieldEntity
  key            String
  label          String
  type           CustomFieldType
  description    String?
  placeholder    String?
  helpText       String?
  options        Json?
  defaultValue   Json?
  required       Boolean            @default(false)
  archived       Boolean            @default(false)
  createdById    String?
  updatedById    String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  tenant         Tenant             @relation(fields: [tenantId], references: [id])
  organization   Organization       @relation(fields: [organizationId], references: [id])
  createdBy      User?              @relation("CustomFieldCreatedBy", fields: [createdById], references: [id])
  updatedBy      User?              @relation("CustomFieldUpdatedBy", fields: [updatedById], references: [id])
  values         CustomFieldValue[]

  @@unique([tenantId, entity, key])
  @@index([tenantId, entity])
}

model CustomFieldValue {
  id        String      @id @default(cuid())
  tenantId  String
  fieldId   String
  personId  String?
  dealId    String?
  value     Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  field     CustomField @relation(fields: [fieldId], references: [id])
  person    Person?     @relation(fields: [personId], references: [id])
  deal      Deal?       @relation(fields: [dealId], references: [id])

  @@index([tenantId, fieldId])
  @@index([tenantId, personId])
  @@index([tenantId, dealId])
}

model CustomFieldLayout {
  id          String            @id @default(cuid())
  tenantId    String
  entity      CustomFieldEntity
  name        String
  description String?
  definition  Json
  isDefault   Boolean           @default(false)
  createdById String?
  updatedById String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  createdBy   User?             @relation("CustomFieldLayoutCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?             @relation("CustomFieldLayoutUpdatedBy", fields: [updatedById], references: [id])

  @@unique([tenantId, entity, name])
  @@index([tenantId, entity])
}

model ContactMergeProposal {
  id                String      @id @default(cuid())
  tenantId          String
  existingPersonId  String
  incomingPayload   Json
  proposedByUserId  String
  status            MergeStatus @default(PENDING)
  resolutionPayload Json?
  resolvedAt        DateTime?
  resolvedByUserId  String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  tenant         Tenant @relation(fields: [tenantId], references: [id])
  existingPerson Person @relation("PersonMergeProposals", fields: [existingPersonId], references: [id])
  proposedBy     User   @relation("MergeProposedBy", fields: [proposedByUserId], references: [id])
  resolvedBy     User?  @relation("MergeResolvedBy", fields: [resolvedByUserId], references: [id])

  @@index([tenantId, status])
}

model Consent {
  id           String         @id @default(cuid())
  tenantId     String
  personId     String
  channel      ConsentChannel
  scope        ConsentScope
  status       ConsentStatus  @default(GRANTED)
  verbatimText String
  source       String
  ipAddress    String?
  userAgent    String?
  evidenceUri  String?
  capturedAt   DateTime       @default(now())
  revokedAt    DateTime?
  actorUserId  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  person       Person         @relation(fields: [personId], references: [id])
  actor        User?          @relation("ConsentActor", fields: [actorUserId], references: [id])

  @@index([personId, channel, scope])
}

model Listing {
  id                 String                 @id @default(cuid())
  tenantId           String
  personId           String?
  opportunityId      String?
  mlsId              String?
  status             ListingStatus          @default(COMING_SOON)
  addressLine1       String
  addressLine2       String?
  city               String
  state              String
  postalCode         String
  country            String                 @default("USA")
  latitude           Float?
  longitude          Float?
  price              Decimal?
  beds               Int?
  baths              Float?
  propertyType       String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  tenant             Tenant                 @relation(fields: [tenantId], references: [id])
  person             Person?                @relation("PersonListings", fields: [personId], references: [id])
  tours              Tour[]
  deals              Deal[]
  offers             Offer[]
  calendarEvents     CalendarEvent[]
  clearCoopTimer     ClearCooperationTimer? @relation("ListingTimer")
  activities         Activity[]
  marketingEvents    MarketingEvent[]
  opportunity        Opportunity?           @relation(fields: [opportunityId], references: [id])
  ListingSearchIndex ListingSearchIndex[]

  @@index([opportunityId])
}

model CalendarEvent {
  id              String                @id @default(cuid())
  tenantId        String
  title           String
  description     String?
  startAt         DateTime
  endAt           DateTime
  eventType       CalendarEventType     @default(OTHER)
  status          CalendarEventStatus   @default(PENDING)
  priority        CalendarEventPriority @default(MEDIUM)
  location        String?
  notes           String?
  assignedAgentId String?
  personId        String?
  listingId       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  assignedAgent User?    @relation("EventAssignedAgent", fields: [assignedAgentId], references: [id])
  person        Person?  @relation(fields: [personId], references: [id])
  listing       Listing? @relation(fields: [listingId], references: [id])

  @@index([tenantId, startAt])
  @@index([assignedAgentId])
  @@index([personId])
}

model Tour {
  id            String             @id @default(cuid())
  tenantId      String
  personId      String
  listingId     String
  agentId       String?
  status        TourStatus         @default(REQUESTED)
  startAt       DateTime
  endAt         DateTime
  source        String?
  routingScore  Float?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  person        Person             @relation(fields: [personId], references: [id])
  listing       Listing            @relation(fields: [listingId], references: [id])
  agent         User?              @relation("TourAgent", fields: [agentId], references: [id])
  agreementLink TourAgreementLink?
  activities    Activity[]
}

model Agreement {
  id             String              @id @default(cuid())
  tenantId       String
  personId       String
  type           AgreementType
  status         AgreementStatus     @default(DRAFT)
  effectiveDate  DateTime?
  expiryDate     DateTime?
  version        Int                 @default(1)
  documentUri    String?
  signatureLog   Json?
  signedAt       DateTime?
  overrideUserId String?
  overrideReason String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  tenant         Tenant              @relation(fields: [tenantId], references: [id])
  person         Person              @relation(fields: [personId], references: [id])
  overrideUser   User?               @relation("AgreementOverride", fields: [overrideUserId], references: [id])
  deals          Deal[]
  tourLinks      TourAgreementLink[]
  activities     Activity[]

  @@index([personId, type, status])
}

model Deal {
  id                 String             @id @default(cuid())
  tenantId           String
  personId           String
  companyId          String?
  listingId          String
  agreementId        String?
  opportunityId      String?
  /// TODO(migrate): ensure stage remains NOT NULL with default 'OFFER'
  stage              DealStage          @default(OFFER)
  forecastGci        Decimal?
  actualGci          Decimal?
  splitPlanRef       String?
  spendToDate        Decimal?           @default(0)
  expectedNet        Decimal?
  commissionSnapshot Json?
  milestoneChecklist Json?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  tenant             Tenant             @relation(fields: [tenantId], references: [id])
  person             Person             @relation(fields: [personId], references: [id])
  company            Company?           @relation(fields: [companyId], references: [id])
  listing            Listing?           @relation(fields: [listingId], references: [id], onDelete: Cascade)
  agreement          Agreement?         @relation(fields: [agreementId], references: [id])
  offers             Offer[]
  activities         Activity[]
  opportunity        Opportunity?       @relation(fields: [opportunityId], references: [id])
  customFieldValues  CustomFieldValue[]

  @@index([opportunityId])
  @@index([tenantId, listingId]) // TODO(migrate): optimise transaction lookups by listing
  @@index([tenantId, stage]) // TODO(migrate): support transaction stage filters
  @@index([tenantId, companyId])
}

model Offer {
  id        String      @id @default(cuid())
  tenantId  String
  listingId String
  personId  String
  dealId    String?
  status    OfferStatus @default(SUBMITTED)
  terms     Json
  amount    Decimal     @db.Decimal(18, 2) @default(0)
  version   Int         @default(1)
  metadata  Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  listing   Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  person    Person      @relation(fields: [personId], references: [id])
  deal      Deal?       @relation(fields: [dealId], references: [id])
  /// TODO(migrate): partial unique index enforcing a single ACCEPTED offer per listing

  @@index([tenantId, listingId, status]) // TODO(migrate): cover listing offer queries
}

model MLSProfile {
  id                       String                  @id @default(cuid())
  tenantId                 String
  name                     String
  disclaimerText           String
  compensationDisplayRule  String
  requiredPlacement        String?                 @default("footer")
  prohibitedFields         Json?
  clearCooperationRequired Boolean                 @default(true)
  slaHours                 Int                     @default(72)
  lastReviewedAt           DateTime?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  tenant                   Tenant                  @relation(fields: [tenantId], references: [id])
  cooperationTimers        ClearCooperationTimer[]
  disclaimerPolicies       DisclaimerPolicy[]
  marketingEvents          MarketingEvent[]
}

model TourAgreementLink {
  tourId      String    @id
  agreementId String
  linkedAt    DateTime  @default(now())
  tour        Tour      @relation(fields: [tourId], references: [id], onDelete: Cascade)
  agreement   Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  @@index([agreementId])
}

model DisclaimerPolicy {
  id                String     @id @default(cuid())
  tenantId          String
  mlsProfileId      String
  requiredText      String
  requiredPlacement String
  compensationRule  String
  lastReviewedAt    DateTime   @default(now())
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  tenant            Tenant     @relation(fields: [tenantId], references: [id])
  mlsProfile        MLSProfile @relation(fields: [mlsProfileId], references: [id])

  @@index([tenantId, mlsProfileId])
}

model OverrideLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorUserId String?
  context     String
  reasonText  String?
  metadata    Json?
  occurredAt  DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  actor       User?    @relation("OverrideActor", fields: [actorUserId], references: [id])

  @@index([tenantId, context])
}

model MarketingEvent {
  id           String      @id @default(cuid())
  tenantId     String
  listingId    String?
  mlsProfileId String?
  eventType    String
  occurredAt   DateTime    @default(now())
  result       String?
  metadata     Json?
  tenant       Tenant      @relation(fields: [tenantId], references: [id])
  listing      Listing?    @relation(fields: [listingId], references: [id])
  mlsProfile   MLSProfile? @relation(fields: [mlsProfileId], references: [id])

  @@index([tenantId, occurredAt])
  @@index([listingId])
  @@index([mlsProfileId])
}

model MarketingCampaign {
  id              String                  @id @default(cuid())
  tenantId        String
  createdById     String?
  personaId       String
  name            String
  subject         String
  body            String
  channel         OutreachChannel         @default(EMAIL)
  audienceKey     String?
  audienceLabel   String?
  callToAction    String?
  recipientsCount Int                     @default(0)
  status          MarketingCampaignStatus @default(DRAFT)
  scheduledAt     DateTime?
  sentAt          DateTime?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  tenant          Tenant                  @relation(fields: [tenantId], references: [id])
  createdBy       User?                   @relation("MarketingCampaignCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model ComplianceStatusDaily {
  id                String   @id @default(cuid())
  tenantId          String
  date              DateTime
  teamId            String?
  agentId           String?
  toursTotal        Int      @default(0)
  toursKept         Int      @default(0)
  keptWithActiveBba Int      @default(0)
  smsGranted        Int      @default(0)
  smsRevoked        Int      @default(0)
  emailGranted      Int      @default(0)
  emailRevoked      Int      @default(0)
  coopOpen          Int      @default(0)
  coopOverdue       Int      @default(0)
  idxFailures       Int      @default(0)
  idxChecks         Int      @default(0)
  tenDlcApproved    Boolean  @default(false)
  dmarcAligned      Boolean  @default(false)
  createdAt         DateTime @default(now())
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, date, teamId, agentId])
}

model CommissionPlan {
  id          String             @id @default(cuid())
  tenantId    String
  name        String
  type        CommissionPlanType
  description String?
  definition  Json
  postCapFee  Json?
  bonusRules  Json?
  isArchived  Boolean            @default(false)
  version     Int                @default(1)
  createdById String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  createdBy   User?              @relation("CommissionPlanCreatedBy", fields: [createdById], references: [id])
  assignments PlanAssignment[]
  snapshots   PlanSnapshot[]
  capLedgers  CapLedger[]

  @@unique([tenantId, name, version])
  @@index([tenantId, isArchived])
}

model PlanAssignment {
  id            String           @id @default(cuid())
  tenantId      String
  assigneeType  PlanAssigneeType
  assigneeId    String
  planId        String
  effectiveFrom DateTime
  effectiveTo   DateTime?
  priority      Int              @default(0)
  createdById   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  plan          CommissionPlan   @relation(fields: [planId], references: [id])
  createdBy     User?            @relation("PlanAssignmentCreatedBy", fields: [createdById], references: [id])

  @@unique([tenantId, assigneeType, assigneeId, planId, effectiveFrom])
  @@index([tenantId, assigneeType, assigneeId, effectiveFrom])
}

model CapLedger {
  id               String         @id @default(cuid())
  tenantId         String
  userId           String
  planId           String
  periodStart      DateTime
  periodEnd        DateTime
  capAmount        Decimal        @db.Decimal(12, 2)
  companyDollarYtd Decimal        @default(0) @db.Decimal(12, 2)
  postCapFeesYtd   Decimal        @default(0) @db.Decimal(12, 2)
  lastDealId       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  tenant           Tenant         @relation(fields: [tenantId], references: [id])
  user             User           @relation(fields: [userId], references: [id])
  plan             CommissionPlan @relation(fields: [planId], references: [id])

  @@unique([tenantId, userId, planId, periodStart])
  @@index([tenantId, userId, planId, periodStart, periodEnd])
}

model PlanSnapshot {
  id          String         @id @default(cuid())
  tenantId    String
  planId      String
  version     Int
  payload     Json
  createdAt   DateTime       @default(now())
  createdById String?
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  plan        CommissionPlan @relation(fields: [planId], references: [id])
  createdBy   User?          @relation("PlanSnapshotCreatedBy", fields: [createdById], references: [id])

  @@unique([planId, version])
  @@index([tenantId, planId, version])
}

model RoutingRule {
  id                        String           @id @default(cuid())
  tenantId                  String
  name                      String
  priority                  Int              @default(0)
  mode                      RoutingMode      @default(FIRST_MATCH)
  enabled                   Boolean          @default(true)
  conditions                Json
  targets                   Json
  fallback                  Json?
  slaFirstTouchMinutes      Int?
  slaKeptAppointmentMinutes Int?
  createdById               String?
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  tenant                    Tenant           @relation(fields: [tenantId], references: [id])
  createdBy                 User?            @relation("RoutingRuleCreatedBy", fields: [createdById], references: [id])
  routeEvents               LeadRouteEvent[]
  slaTimers                 LeadSlaTimer[]

  @@index([tenantId, priority])
}

model LeadRouteEvent {
  id              String       @id @default(cuid())
  tenantId        String
  leadId          String
  personId        String?
  matchedRuleId   String?
  mode            RoutingMode
  payload         Json
  candidates      Json
  assignedAgentId String?
  fallbackUsed    Boolean      @default(false)
  reasonCodes     Json?
  slaDueAt        DateTime?
  slaSatisfiedAt  DateTime?
  slaBreachedAt   DateTime?
  actorUserId     String?
  createdAt       DateTime     @default(now())
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  rule            RoutingRule? @relation(fields: [matchedRuleId], references: [id])
  actor           User?        @relation("RouteEventActor", fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, leadId])
}

model Queue {
  id             String            @id @default(cuid())
  tenantId       String
  organizationId String
  name           String
  description    String?
  routingMode    RoutingMode       @default(FIRST_MATCH)
  visibility     QueueVisibility   @default(ORGANIZATION)
  isActive       Boolean           @default(true)
  slaMinutes     Int?
  metadata       Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id])
  assignments    QueueAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId, routingMode, isActive])
}

model QueueAssignment {
  id           String    @id @default(cuid())
  tenantId     String
  queueId      String
  personId     String
  assigneeId   String?
  claimedAt    DateTime  @default(now())
  expiresAt    DateTime?
  releasedAt   DateTime?
  breachedAt   DateTime?
  breachReason String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  queue        Queue     @relation(fields: [queueId], references: [id], onDelete: Cascade)
  person       Person    @relation("QueueAssignmentPerson", fields: [personId], references: [id])
  assignee     User?     @relation("QueueAssignmentAssignee", fields: [assigneeId], references: [id])

  @@index([tenantId, queueId])
  @@index([tenantId, personId])
  @@index([tenantId, assigneeId])
  @@index([tenantId, expiresAt])
}

model LeadSlaTimer {
  id              String       @id @default(cuid())
  tenantId        String
  leadId          String
  assignedAgentId String?
  ruleId          String?
  type            LeadSlaType  @default(FIRST_TOUCH)
  status          String       @default("PENDING")
  dueAt           DateTime
  satisfiedAt     DateTime?
  breachedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  rule            RoutingRule? @relation(fields: [ruleId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, status])
}

model Message {
  id                String              @id @default(cuid())
  tenantId          String
  personId          String?
  userId            String?
  conversationId    String?
  channel           MessageChannel
  direction         MessageDirection
  subject           String?
  body              String?
  toAddress         String?
  fromAddress       String?
  status            MessageStatus       @default(QUEUED)
  errorCode         String?
  errorMessage      String?
  metadata          Json?
  deliveredAt       DateTime?
  providerMessageId String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  tenant            Tenant              @relation(fields: [tenantId], references: [id])
  person            Person?             @relation(fields: [personId], references: [id])
  user              User?               @relation(fields: [userId], references: [id])
  conversation      Conversation?       @relation(fields: [conversationId], references: [id])
  attachments       MessageAttachment[]
  receipts          MessageReceipt[]

  @@index([conversationId])
}

model Conversation {
  id           String                    @id @default(cuid())
  tenantId     String
  type         ConversationType
  personId     String?
  createdById  String
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  archivedAt   DateTime?
  tenant       Tenant                    @relation(fields: [tenantId], references: [id])
  person       Person?                   @relation("PersonConversations", fields: [personId], references: [id])
  createdBy    User                      @relation("ConversationCreatedBy", fields: [createdById], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  touchpoints  Touchpoint[]

  @@index([tenantId, type])
  @@index([tenantId, personId])
  @@index([tenantId, updatedAt])
}

model ConversationParticipant {
  id             String                      @id @default(cuid())
  conversationId String
  userId         String?
  personId       String?
  role           ConversationParticipantRole @default(MEMBER)
  joinedAt       DateTime                    @default(now())
  muted          Boolean                     @default(false)
  lastReadAt     DateTime?
  conversation   Conversation                @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?                       @relation("ConversationParticipantUser", fields: [userId], references: [id])
  person         Person?                     @relation("ConversationParticipantPerson", fields: [personId], references: [id])
  receipts       MessageReceipt[]

  @@index([conversationId, role])
  @@index([conversationId, userId])
  @@index([conversationId, personId])
}

model MessageReceipt {
  id            String                  @id @default(cuid())
  messageId     String
  participantId String
  status        MessageReceiptStatus
  recordedAt    DateTime                @default(now())
  message       Message                 @relation(fields: [messageId], references: [id], onDelete: Cascade)
  participant   ConversationParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([messageId, participantId, status])
  @@index([participantId, status])
}

model MessageAttachment {
  id         String   @id @default(cuid())
  messageId  String
  filename   String
  mimeType   String
  size       Int
  storageKey String
  checksum   String?
  scanned    Boolean  @default(false)
  createdAt  DateTime @default(now())
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([checksum])
}

model Activity {
  id          String       @id @default(cuid())
  tenantId    String
  personId    String?
  userId      String?
  dealId      String?
  tourId      String?
  agreementId String?
  listingId   String?
  type        ActivityType
  payload     Json
  occurredAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  person      Person?      @relation(fields: [personId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])
  deal        Deal?        @relation(fields: [dealId], references: [id])
  tour        Tour?        @relation(fields: [tourId], references: [id])
  agreement   Agreement?   @relation(fields: [agreementId], references: [id])
  listing     Listing?     @relation(fields: [listingId], references: [id])
}

model Outbox {
  id          String            @id @default(cuid())
  tenantId    String
  eventType   String
  payload     Json
  status      OutboxStatus      @default(PENDING)
  attempts    Int               @default(0)
  lastError   String?
  lockedAt    DateTime?
  nextRetryAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  deliveries  WebhookDelivery[]
}

model Assignment {
  id         String             @id @default(cuid())
  tenantId   String
  personId   String
  agentId    String?
  teamId     String?
  score      Float
  reasons    AssignmentReason[]
  assignedAt DateTime           @default(now())
  expiresAt  DateTime?
  createdAt  DateTime           @default(now())
  tenant     Tenant             @relation(fields: [tenantId], references: [id])
  person     Person             @relation(fields: [personId], references: [id])
  agent      User?              @relation(fields: [agentId], references: [id])
  team       Team?              @relation(fields: [teamId], references: [id])
}

model AssignmentReason {
  id           String               @id @default(cuid())
  assignmentId String
  type         AssignmentReasonType
  weight       Float
  notes        String?
  assignment   Assignment           @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model Journey {
  id          String              @id @default(cuid())
  tenantId    String
  name        String
  trigger     JourneyTrigger
  isActive    Boolean             @default(true)
  definition  Json // conditions + actions structure
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  simulations JourneySimulation[]
}

model JourneySimulation {
  id        String   @id @default(cuid())
  journeyId String
  tenantId  String
  leadId    String
  input     Json
  result    Json
  createdAt DateTime @default(now())
  journey   Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  lead      Person   @relation(fields: [leadId], references: [id])

  @@unique([tenantId, leadId, journeyId])
}

model CommunicationBlock {
  id        String         @id @default(cuid())
  tenantId  String
  personId  String?
  channel   ConsentChannel
  scope     ConsentScope?
  reason    String
  createdAt DateTime       @default(now())
  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  person    Person?        @relation(fields: [personId], references: [id])

  @@index([personId, channel])
}

model ClearCooperationTimer {
  id                     String                 @id @default(cuid())
  tenantId               String
  listingId              String?                @unique
  mlsProfileId           String?
  status                 ClearCooperationStatus @default(GREEN)
  startedAt              DateTime               @default(now())
  firstPublicMarketingAt DateTime?
  deadlineAt             DateTime?
  dueAt                  DateTime?
  lastEventAt            DateTime?
  riskReason             String?
  lastAction             String?
  lastActorId            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  tenant                 Tenant                 @relation(fields: [tenantId], references: [id])
  listing                Listing?               @relation("ListingTimer", fields: [listingId], references: [id])
  mlsProfile             MLSProfile?            @relation(fields: [mlsProfileId], references: [id])
  lastActor              User?                  @relation("CooperationLastActor", fields: [lastActorId], references: [id])
}

model PersonDocument {
  id        String   @id @default(cuid())
  personId  String
  tenantId  String
  type      String
  url       String
  createdAt DateTime @default(now())
  metadata  Json?
  person    Person   @relation(fields: [personId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  before      Json?
  after       Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  actor       User?    @relation(fields: [actorUserId], references: [id])
}

model DeliverabilityMetric {
  id          String         @id @default(cuid())
  tenantId    String
  campaignRef String?
  agentId     String?
  channel     MessageChannel
  accepted    Int            @default(0)
  delivered   Int            @default(0)
  bounced     Int            @default(0)
  complaints  Int            @default(0)
  optOuts     Int            @default(0)
  recordedAt  DateTime       @default(now())
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  agent       User?          @relation(fields: [agentId], references: [id])

  @@unique([tenantId, agentId, channel, recordedAt])
}

model QuietHourOverride {
  id         String         @id @default(cuid())
  tenantId   String
  personId   String?
  channel    ConsentChannel
  reason     String
  validUntil DateTime
  createdAt  DateTime       @default(now())
  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  person     Person?        @relation(fields: [personId], references: [id])
}

model RoutingLog {
  id          String   @id @default(cuid())
  tenantId    String
  personId    String
  ruleName    String
  prevOwnerId String?
  newOwnerId  String?
  details     Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  person      Person   @relation(fields: [personId], references: [id])

  @@index([tenantId, personId])
}

model WebhookSubscription {
  id         String            @id @default(cuid())
  tenantId   String
  name       String
  url        String
  secret     String
  isActive   Boolean           @default(true)
  eventTypes String[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  tenant     Tenant            @relation(fields: [tenantId], references: [id])
  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id          String              @id @default(cuid())
  webhookId   String
  outboxId    String
  status      OutboxStatus        @default(PENDING)
  attempts    Int                 @default(0)
  lastError   String?
  deliveredAt DateTime?
  createdAt   DateTime            @default(now())
  webhook     WebhookSubscription @relation(fields: [webhookId], references: [id])
  outbox      Outbox              @relation(fields: [outboxId], references: [id])
}

model UserOrgMembership {
  id         String       @id @default(cuid())
  userId     String
  orgId      String
  roleId     String?
  profileId  String?
  isOrgAdmin Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id])
  org        Organization @relation(fields: [orgId], references: [id])
  role       Role?        @relation("RoleMemberships", fields: [roleId], references: [id])
  profile    Profile?     @relation(fields: [profileId], references: [id])

  @@unique([userId, orgId])
  @@index([orgId])
  @@index([profileId])
}

model Role {
  id        String              @id @default(cuid())
  orgId     String
  name      String
  parentId  String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  org       Organization        @relation(fields: [orgId], references: [id])
  parent    Role?               @relation("RoleToRole", fields: [parentId], references: [id])
  children  Role[]              @relation("RoleToRole")
  members   UserOrgMembership[] @relation("RoleMemberships")

  @@index([orgId])
}

model Profile {
  id                String              @id @default(cuid())
  orgId             String
  name              String
  isSystem          Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  org               Organization        @relation(fields: [orgId], references: [id])
  objectPermissions ObjectPermission[]  @relation("ProfileObjectPermissions")
  fieldPermissions  FieldPermission[]   @relation("ProfileFieldPermissions")
  memberships       UserOrgMembership[]

  @@index([orgId])
}

model PermissionSet {
  id                String                    @id @default(cuid())
  orgId             String
  name              String
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  org               Organization              @relation(fields: [orgId], references: [id])
  assignments       PermissionSetAssignment[]
  objectPermissions ObjectPermission[]        @relation("PermissionSetObjectPermissions")
  fieldPermissions  FieldPermission[]         @relation("PermissionSetFieldPermissions")

  @@index([orgId])
}

model PermissionSetAssignment {
  id              String        @id @default(cuid())
  userId          String
  permissionSetId String
  assignedAt      DateTime      @default(now())
  user            User          @relation(fields: [userId], references: [id])
  permissionSet   PermissionSet @relation(fields: [permissionSetId], references: [id])

  @@unique([userId, permissionSetId])
  @@index([permissionSetId])
}

model ObjectPermission {
  id              String               @id @default(cuid())
  orgId           String
  holderType      PermissionHolderType
  holderId        String
  object          String
  canCreate       Boolean              @default(false)
  canRead         Boolean              @default(true)
  canUpdate       Boolean              @default(false)
  canDelete       Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  org             Organization         @relation(fields: [orgId], references: [id])
  profileId       String?
  permissionSetId String?
  profile         Profile?             @relation("ProfileObjectPermissions", fields: [profileId], references: [id])
  permissionSet   PermissionSet?       @relation("PermissionSetObjectPermissions", fields: [permissionSetId], references: [id])

  @@index([orgId, holderType, holderId, object])
  @@index([profileId])
  @@index([permissionSetId])
}

model FieldPermission {
  id              String               @id @default(cuid())
  orgId           String
  holderType      PermissionHolderType
  holderId        String
  object          String
  field           String
  canRead         Boolean              @default(true)
  canWrite        Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  org             Organization         @relation(fields: [orgId], references: [id])
  profileId       String?
  permissionSetId String?
  profile         Profile?             @relation("ProfileFieldPermissions", fields: [profileId], references: [id])
  permissionSet   PermissionSet?       @relation("PermissionSetFieldPermissions", fields: [permissionSetId], references: [id])

  @@index([orgId, holderType, holderId, object, field])
  @@index([profileId])
  @@index([permissionSetId])
}

model RecordShare {
  id          String           @id @default(cuid())
  orgId       String
  object      String
  recordId    String
  granteeType ShareGranteeType
  granteeId   String
  access      ShareAccess
  createdAt   DateTime         @default(now())
  org         Organization     @relation(fields: [orgId], references: [id])

  @@index([orgId, object, recordId])
}

model AuditEvent {
  id        String       @id @default(cuid())
  orgId     String
  actorId   String?
  object    String?
  recordId  String?
  action    AuditAction
  diff      Json?
  ip        String?
  userAgent String?
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id])
  actor     User?        @relation(fields: [actorId], references: [id])

  @@index([orgId, object, recordId])
}

/// Admin-configured validation rules per object
model ValidationRule {
  id        String   @id @default(uuid())
  orgId     String
  object    String // e.g., 'cases','opportunities','accounts','re_offers'
  name      String
  active    Boolean  @default(true)
  // Simple JSON DSL, e.g. { "if": "status in ['Resolved','Closed']", "then_required": ["description"] }
  dsl       Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, object, active])
}

/// Admin-configured assignment rules per object
model AssignmentRule {
  id        String   @id @default(uuid())
  orgId     String
  object    String
  name      String
  active    Boolean  @default(true)
  // DSL example: { "when": "stage == 'Qualification' && amount >= 50000",
  //                "assign": { "type": "round_robin", "pool": ["u1","u2"] } }
  dsl       Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, object, active])
}

// TODO(migrate): consider NOT NULLs for object/name; add FKs to users for static assignees later

model Account {
  id              String        @id @default(uuid())
  orgId           String
  ownerId         String
  name            String
  website         String?
  industry        String?
  annualRevenue   Decimal?      @db.Decimal(18, 2)
  phone           String?
  billingAddress  Json?
  shippingAddress Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?
  opportunities   Opportunity[]
  cases           Case[]        @relation("CaseAccount")

  @@index([orgId, name])
}

model Opportunity {
  id           String    @id @default(uuid())
  orgId        String
  ownerId      String
  accountId    String?
  name         String
  stage        String
  amount       Decimal?  @db.Decimal(18, 2)
  currency     String    @default("USD")
  closeDate    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  account      Account?  @relation(fields: [accountId], references: [id])
  listings     Listing[]
  transactions Deal[]

  @@index([orgId, stage, closeDate])
}

model FileObject {
  id                    String                 @id @default(uuid())
  orgId                 String
  ownerId               String
  fileName              String
  mimeType              String?
  byteSize              Int
  storageKey            String
  status                String                 @default("READY")
  createdAt             DateTime               @default(now())
  links                 FileLink[]
  orgFiles              OrgFile[]
  orgMessageAttachments OrgMessageAttachment[]

  @@index([orgId, storageKey])
}

model FileLink {
  id        String     @id @default(uuid())
  orgId     String
  fileId    String
  object    String
  recordId  String
  createdAt DateTime   @default(now())
  file      FileObject @relation(fields: [fileId], references: [id])

  @@index([orgId, object, recordId])
}

model DealDeskRequest {
  id            String    @id @default(uuid())
  orgId         String
  requesterId   String
  opportunityId String
  status        String    @default("PENDING")
  amount        Decimal?  @db.Decimal(18, 2)
  discountPct   Decimal?  @db.Decimal(5, 2)
  reason        String?
  createdAt     DateTime  @default(now())
  decidedAt     DateTime?
  decidedBy     String?

  @@index([orgId, status, opportunityId])
}

model OrgCommissionPlan {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  brokerSplit Decimal  @db.Decimal(5, 2)
  agentSplit  Decimal  @db.Decimal(5, 2)
  tiers       Json?
  createdAt   DateTime @default(now())

  @@index([orgId, name])
}

model MetricsDaily {
  id        String   @id @default(cuid())
  orgId     String
  key       String
  date      DateTime
  valueNum  Decimal?
  valueJson Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, key, date])
}

model MetricsRun {
  id         String    @id @default(cuid())
  orgId      String
  key        String
  status     String
  note       String?
  createdAt  DateTime  @default(now())
  finishedAt DateTime?

  @@index([orgId, key, createdAt])
}

model Case {
  id          String    @id @default(uuid())
  orgId       String
  ownerId     String
  accountId   String?
  contactId   String?
  subject     String
  status      String    @default("New") // New|Working|Escalated|Resolved|Closed
  priority    String?   @default("Medium") // Low|Medium|High|Urgent
  origin      String? // Email|Phone|Web|Other
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  account Account? @relation("CaseAccount", fields: [accountId], references: [id])
  contact Person?  @relation("CaseContact", fields: [contactId], references: [id])

  @@index([orgId, status, priority])
}

// TODO(migrate): add NOT NULL where noted by service checks; confirm FK options

model Payout {
  id            String    @id @default(uuid())
  orgId         String
  transactionId String?
  opportunityId String?
  payeeId       String
  grossAmount   Decimal   @db.Decimal(18, 2)
  brokerAmount  Decimal   @db.Decimal(18, 2)
  agentAmount   Decimal   @db.Decimal(18, 2)
  status        String    @default("PENDING")
  dueOn         DateTime?
  paidAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([orgId, status])
}

// S9: Record Types & Layouts
model RecordType {
  id        String         @id @default(cuid())
  orgId     String
  object    String
  key       String
  label     String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  layouts   ObjectLayout[]

  @@unique([orgId, object, key])
  @@index([orgId, object])
}

model ObjectLayout {
  id           String        @id @default(cuid())
  orgId        String
  object       String
  kind         String
  recordTypeId String?
  profile      String?
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  recordType   RecordType?   @relation(fields: [recordTypeId], references: [id])
  fields       FieldLayout[]

  @@unique([orgId, object, kind, recordTypeId, profile])
  @@index([orgId, object, kind])
  @@index([orgId, object, kind, profile])
  @@index([orgId, object, kind, recordTypeId, profile])
}

model FieldLayout {
  id        String       @id @default(cuid())
  layoutId  String
  field     String
  label     String?
  visible   Boolean      @default(true)
  order     Int
  width     Int?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  layout    ObjectLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId, order])
}

model OrgDailyAnalytics {
  id                         String               @id @default(cuid())
  organizationId             String
  organization               Organization         @relation(fields: [organizationId], references: [id])
  date                       DateTime
  granularity                AnalyticsGranularity @default(DAILY)
  leadsNewCount              Int                  @default(0)
  leadsContactedCount        Int                  @default(0)
  leadsQualifiedCount        Int                  @default(0)
  leadsUnderContractCount    Int                  @default(0)
  leadsClosedCount           Int                  @default(0)
  offerIntentsSubmittedCount Int                  @default(0)
  offerIntentsAcceptedCount  Int                  @default(0)
  offerIntentsDeclinedCount  Int                  @default(0)
  transactionsClosedCount    Int                  @default(0)
  transactionsClosedVolume   Int                  @default(0)
  averageDaysOnMarket        Int                  @default(0)
  activeLeasesCount          Int                  @default(0)
  pmIncomeEstimate           Int                  @default(0)
  savedListingsCount         Int                  @default(0)
  savedSearchesCount         Int                  @default(0)
  copilotActionsSuggestedCount Int                @default(0)
  copilotActionsCompletedCount Int                @default(0)
  createdAt                  DateTime             @default(now())

  @@unique([organizationId, date, granularity])
  @@index([organizationId, date])
}

model AgentDailyAnalytics {
  id                        String               @id @default(cuid())
  organizationId            String
  organization              Organization         @relation(fields: [organizationId], references: [id])
  agentProfileId            String
  agentProfile              AgentProfile         @relation(fields: [agentProfileId], references: [id])
  date                      DateTime
  granularity               AnalyticsGranularity @default(DAILY)
  leadsNewCount             Int                  @default(0)
  leadsContactedCount       Int                  @default(0)
  leadsQualifiedCount       Int                  @default(0)
  leadsUnderContractCount   Int                  @default(0)
  leadsClosedCount          Int                  @default(0)
  offerIntentsSubmittedCount Int                 @default(0)
  offerIntentsAcceptedCount Int                  @default(0)
  transactionsClosedCount   Int                  @default(0)
  transactionsClosedVolume  Int                  @default(0)
  activeLeasesCount         Int                  @default(0)
  copilotActionsSuggestedCount Int               @default(0)
  copilotActionsCompletedCount Int               @default(0)
  createdAt                 DateTime             @default(now())

  @@unique([organizationId, agentProfileId, date, granularity])
  @@index([organizationId, agentProfileId, date])
}

model BatchEvent {
  id         String   @id @default(cuid())
  externalId String   @unique
  type       String
  occurredAt DateTime
  payload    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ============================================
// EXTERNAL MARKET DATA MODELS (Atlas/MLS)
// ============================================

/// External MLS listings from data feeds (not tenant-specific)
/// This is the source of truth for Atlas market analysis
model MlsListing {
  id              String    @id @default(cuid())
  mlsId           String    @unique // External MLS ID
  mlsSource       String    // e.g., "NABOR", "Stellar", "Bright"

  // Address
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  county          String?
  latitude        Float?
  longitude       Float?

  // Property details
  listPrice       Decimal?
  bedrooms        Int?
  bathrooms       Float?
  squareFeet      Int?
  lotSize         Int?      // Square feet
  yearBuilt       Int?
  propertyType    String?   // e.g., "Single Family", "Condo", "Townhouse"
  propertySubType String?

  // Listing metadata
  status          String    // e.g., "ACTIVE", "PENDING", "SOLD", "WITHDRAWN"
  listingDate     DateTime?
  statusChangeDate DateTime?
  daysOnMarket    Int?

  // Additional details
  description     String?
  photoUrls       String[]  // Array of photo URLs
  virtualTourUrl  String?

  // Agent/Office info
  listingAgentName   String?
  listingOfficeName  String?

  // System metadata
  importedAt      DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([city, state, status])
  @@index([listPrice, bedrooms, bathrooms])
  @@index([status, listingDate])
  @@index([mlsSource])
}

/// Sold properties (comparables) from external data feeds
/// Used for pricing analysis and market comps
model MarketComparable {
  id              String    @id @default(cuid())
  mlsId           String?   // External MLS ID (if available)
  mlsSource       String    // e.g., "NABOR", "Stellar", "Public Records"

  // Address
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  county          String?
  latitude        Float?
  longitude       Float?

  // Property details
  salePrice       Decimal   // Actual sale price
  originalListPrice Decimal? // Original list price
  bedrooms        Int?
  bathrooms       Float?
  squareFeet      Int?
  lotSize         Int?
  yearBuilt       Int?
  propertyType    String?

  // Sale metadata
  saleDate        DateTime  // Closing date
  daysOnMarket    Int?

  // System metadata
  importedAt      DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([city, state, saleDate])
  @@index([salePrice, bedrooms, bathrooms])
  @@index([saleDate])
  @@index([mlsSource])
}

/// Aggregated market statistics by geography
/// Pre-calculated metrics for faster Atlas queries
model MarketMetrics {
  id                String    @id @default(cuid())

  // Geography
  city              String
  state             String
  postalCode        String?
  county            String?

  // Time period
  periodStart       DateTime
  periodEnd         DateTime
  granularity       String    // e.g., "DAILY", "WEEKLY", "MONTHLY"

  // Inventory metrics
  activeListings    Int       @default(0)
  newListings       Int       @default(0)
  pendingListings   Int       @default(0)
  soldListings      Int       @default(0)

  // Price metrics
  medianListPrice   Decimal?
  medianSalePrice   Decimal?
  avgListPrice      Decimal?
  avgSalePrice      Decimal?

  // Market velocity
  avgDaysOnMarket   Int?
  inventoryMonths   Float?    // Months of inventory

  // System metadata
  calculatedAt      DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([city, state, postalCode, periodStart, granularity])
  @@index([city, state, periodStart])
}
