generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions        = [citext()]
}

enum UserRole {
  BROKER
  TEAM_LEAD
  AGENT
  ISA
  MARKETING
  LENDER
}

enum PersonStage {
  NEW
  NURTURE
  ACTIVE
  UNDER_CONTRACT
  CLOSED
  LOST
}

enum ConsentChannel {
  EMAIL
  SMS
  VOICE
}

enum ConsentScope {
  PROMOTIONAL
  TRANSACTIONAL
}

enum ConsentStatus {
  GRANTED
  REVOKED
  UNKNOWN
}

enum ListingStatus {
  COMING_SOON
  ACTIVE
  PENDING
  CLOSED
  WITHDRAWN
}

enum TourStatus {
  REQUESTED
  CONFIRMED
  KEPT
  NO_SHOW
  CANCELLED
}

enum AgreementType {
  BUYER_REP
  LISTING
}

enum AgreementStatus {
  DRAFT
  SIGNED
  EXPIRED
}

enum DealStage {
  OFFER
  UNDER_CONTRACT
  CLOSED
  LOST
}

enum OfferStatus {
  SUBMITTED
  COUNTERED
  ACCEPTED
  REJECTED
}

enum MessageChannel {
  EMAIL
  SMS
  VOICE
  IN_APP
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
  BLOCKED
  READ
}

enum ConversationType {
  EXTERNAL
  INTERNAL
}

enum ConversationParticipantRole {
  OWNER
  MEMBER
  VIEWER
}

enum MessageReceiptStatus {
  DELIVERED
  READ
}

enum ActivityType {
  LEAD_CREATED
  CONSENT_CAPTURED
  CONSENT_REVOKED
  TOUR_REQUESTED
  TOUR_CONFIRMED
  TOUR_KEPT
  AGREEMENT_SIGNED
  DEAL_STAGE_CHANGED
  MESSAGE_SENT
  MESSAGE_READ
  MESSAGE_FAILED
  MESSAGE_BLOCKED
  COMPLIANCE_VIOLATION
  ROUTING_ASSIGNED
  CONTACT_MERGE_PROPOSED
  CONTACT_MERGED
  CONTACT_EMAIL_CHANGED
  CONTACT_PHONE_CHANGED
  CONTACT_STAGE_CHANGED
  CONTACT_OWNER_CHANGED
  CONTACT_TAGS_CHANGED
  CONTACT_DELETED
  CONTACT_RESTORED
  NOTE_ADDED
  COMMISSION_PLAN_CREATED
  COMMISSION_PLAN_UPDATED
  COMMISSION_PLAN_ARCHIVED
  COMMISSION_PLAN_ASSIGNED
  COMMISSION_PLAN_ASSIGNMENT_ENDED
  CAP_LEDGER_UPDATED
}

enum RoutingMode {
  FIRST_MATCH
  SCORE_AND_ASSIGN
}

enum LeadSlaType {
  FIRST_TOUCH
  KEPT_APPOINTMENT
}

enum OutboxStatus {
  PENDING
  DELIVERING
  SUCCESS
  FAILED
}

enum ContactSource {
  MANUAL
  CSV_IMPORT
  PORTAL
  OPEN_HOUSE
  API
  REFERRAL
}

enum BuyerRepStatus {
  ACTIVE
  NONE
  EXPIRED
}

enum LeadScoreTier {
  A
  B
  C
  D
}

enum LeadTaskStatus {
  OPEN
  DONE
}

enum LeadTouchpointType {
  MESSAGE
  CALL
  MEETING
  TASK
  NOTE
  OTHER
}

enum MergeStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PermissionHolderType {
  PROFILE
  PERMISSION_SET
}

enum ShareGranteeType {
  USER
  ROLE
  TEAM
}

enum ShareAccess {
  READ
  WRITE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SHARE
  LOGIN
}

enum AssignmentReasonType {
  CAPACITY
  PERFORMANCE
  GEOGRAPHY
  PRICE_BAND
  CONSENT
  TEN_DLC
  ROUND_ROBIN
  TEAM_POND
}

enum CommissionPlanType {
  FLAT
  TIERED
  CAP
}

enum PlanAssigneeType {
  USER
  TEAM
}

enum ClearCooperationStatus {
  GREEN
  YELLOW
  RED
}

enum JourneyTrigger {
  LEAD_CREATED
  CONSENT_CAPTURED
  TOUR_KEPT
  DEAL_STAGE_CHANGED
}

enum JourneyActionType {
  ASSIGN
  SEND_MESSAGE
  CREATE_TASK
  UPDATE_STAGE
}

enum CalendarEventType {
  SHOWING
  MEETING
  INSPECTION
  CLOSING
  FOLLOW_UP
  MARKETING
  OTHER
}

enum CalendarEventStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum CalendarEventPriority {
  LOW
  MEDIUM
  HIGH
}

enum SavedViewScope {
  PRIVATE
  TEAM
  ORGANIZATION
}

enum CustomFieldEntity {
  CONTACT
  DEAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
}

enum SequenceEnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELED
}

enum SequenceStepStatus {
  PENDING
  SCHEDULED
  SENT
  SKIPPED
  COMPLETED
  FAILED
  CANCELED
}

model Organization {
  id                String              @id @default(cuid())
  name              String
  plan              String?             @default("standard")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  tenants           Tenant[]
  users             User[]
  people            Person[]
  teamMembers       TeamMember[]
  teams             Team[]
  orgMemberships    UserOrgMembership[]
  roles             Role[]
  profiles          Profile[]
  permissionSets    PermissionSet[]
  objectPermissions ObjectPermission[]
  fieldPermissions  FieldPermission[]
  recordShares      RecordShare[]
  companies         Company[]
  households        Household[]
  customFields      CustomField[]
  sequences         Sequence[]
  auditEvents       AuditEvent[]
}

model Tenant {
  id                    String                  @id @default(cuid())
  organizationId        String
  name                  String
  slug                  String                  @unique
  timezone              String                  @default("America/New_York")
  quietHoursStart       Int                     @default(21) // 24h clock hour
  quietHoursEnd         Int                     @default(8) // 24h clock hour
  inAppRetentionMonths  Int                     @default(18)
  tenDlcReady           Boolean                 @default(false)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  organization          Organization            @relation(fields: [organizationId], references: [id])
  users                 User[]
  teams                 Team[]
  people                Person[]
  companies             Company[]
  households            Household[]
  listings              Listing[]
  consents              Consent[]
  tours                 Tour[]
  agreements            Agreement[]
  deliverabilityMetrics DeliverabilityMetric[]
  quietHourOverrides    QuietHourOverride[]
  routingLogs           RoutingLog[]
  webhookSubscriptions  WebhookSubscription[]
  personDocuments       PersonDocument[]
  auditLogs             AuditLog[]
  deals                 Deal[]
  offers                Offer[]
  mlsProfiles           MLSProfile[]
  messages              Message[]
  conversations         Conversation[]
  activities            Activity[]
  outboxEvents          Outbox[]
  calendarEvents        CalendarEvent[]
  assignments           Assignment[]
  journeys              Journey[]
  clearCooperation      ClearCooperationTimer[]
  consentBlocks         CommunicationBlock[]
  teamMembers           TeamMember[]
  savedViews            SavedView[]
  sequences             Sequence[]
  sequenceEnrollments   SequenceEnrollment[]
  sequenceStepLogs      SequenceStepLog[]
  mergeProposals        ContactMergeProposal[]
  disclaimerPolicies    DisclaimerPolicy[]
  overrideLogs          OverrideLog[]
  marketingEvents       MarketingEvent[]
  complianceSnapshots   ComplianceStatusDaily[]
  routingRules          RoutingRule[]
  routeEvents           LeadRouteEvent[]
  slaTimers             LeadSlaTimer[]
  commissionPlans       CommissionPlan[]
  planAssignments       PlanAssignment[]
  capLedgers            CapLedger[]
  planSnapshots         PlanSnapshot[]
  pipelines             Pipeline[]
  stages                Stage[]
  leadFits              LeadFit[]
  events                Event[]
  leadActivityRollups   LeadActivityRollup[]
  leadNotes             LeadNote[]
  leadTasks             LeadTask[]
  leadTouchpoints       LeadTouchpoint[]
  customFields          CustomField[]
  customFieldValues     CustomFieldValue[]
  customFieldLayouts    CustomFieldLayout[]
}

model User {
  id                        String                    @id @default(cuid())
  organizationId            String
  tenantId                  String
  email                     String                    @unique @db.Citext
  firstName                 String
  lastName                  String
  role                      UserRole
  status                    String                    @default("active")
  avatarUrl                 String?
  timezone                  String?
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  organization              Organization              @relation(fields: [organizationId], references: [id])
  tenant                    Tenant                    @relation(fields: [tenantId], references: [id])
  memberships               TeamMembership[]
  orgMemberships            UserOrgMembership[]
  permissionSetAssignments  PermissionSetAssignment[]
  ownedPeople               Person[]                  @relation("PersonOwner")
  commissionPlansCreated    CommissionPlan[]          @relation("CommissionPlanCreatedBy")
  planAssignmentsCreated    PlanAssignment[]          @relation("PlanAssignmentCreatedBy")
  planSnapshotsCreated      PlanSnapshot[]            @relation("PlanSnapshotCreatedBy")
  capLedgers                CapLedger[]
  tours                     Tour[]                    @relation("TourAgent")
  messages                  Message[]
  createdConversations      Conversation[]            @relation("ConversationCreatedBy")
  conversationMemberships   ConversationParticipant[] @relation("ConversationParticipantUser")
  assignments               Assignment[]
  activities                Activity[]
  calendarEvents            CalendarEvent[]           @relation("EventAssignedAgent")
  actedConsents             Consent[]                 @relation("ConsentActor")
  overrideAgreements        Agreement[]               @relation("AgreementOverride")
  deliverabilityMetrics     DeliverabilityMetric[]
  auditLogs                 AuditLog[]
  savedViews                SavedView[]
  proposedMerges            ContactMergeProposal[]    @relation("MergeProposedBy")
  resolvedMerges            ContactMergeProposal[]    @relation("MergeResolvedBy")
  overrideEntries           OverrideLog[]             @relation("OverrideActor")
  cooperationActions        ClearCooperationTimer[]   @relation("CooperationLastActor")
  routingRulesCreated       RoutingRule[]             @relation("RoutingRuleCreatedBy")
  routeEventsActor          LeadRouteEvent[]          @relation("RouteEventActor")
  leadNotesAuthored         LeadNote[]                @relation("LeadNoteAuthor")
  leadTasksAssigned         LeadTask[]                @relation("LeadTaskAssignee")
  leadTouchpoints           LeadTouchpoint[]
  auditEvents               AuditEvent[]
  companiesOwned            Company[]                 @relation("CompanyOwner")
  householdsOwned           Household[]               @relation("HouseholdOwner")
  sequencesCreated          Sequence[]                @relation("SequenceCreatedBy")
  sequencesUpdated          Sequence[]                @relation("SequenceUpdatedBy")
  sequenceEnrollments       SequenceEnrollment[]      @relation("SequenceEnrollmentOwner")
  customFieldsCreated       CustomField[]             @relation("CustomFieldCreatedBy")
  customFieldsUpdated       CustomField[]             @relation("CustomFieldUpdatedBy")
  customFieldLayoutsCreated CustomFieldLayout[]       @relation("CustomFieldLayoutCreatedBy")
  customFieldLayoutsUpdated CustomFieldLayout[]       @relation("CustomFieldLayoutUpdatedBy")
}

model Team {
  id          String           @id @default(cuid())
  tenantId    String
  orgId       String
  name        String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  org         Organization     @relation(fields: [orgId], references: [id])
  members     TeamMembership[]
  assignments Assignment[]
  savedViews  SavedView[]

  @@index([orgId])
}

model TeamMembership {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model TeamMember {
  id                String        @id @default(uuid()) @map("id") @db.Uuid
  tenantId          String        @map("tenant_id")
  orgId             String?       @map("org_id")
  name              String        @map("name")
  email             String        @map("email")
  phone             String?       @map("phone")
  role              String        @default("Agent") @map("role")
  status            String        @default("active") @map("status")
  experienceYears   Int?          @map("experience_years")
  rating            Float         @default(0) @map("rating")
  totalSales        Int           @default(0) @map("total_sales")
  dealsInProgress   Int           @default(0) @map("deals_in_progress")
  openLeads         Int           @default(0) @map("open_leads")
  responseTimeHours Float         @default(0) @map("response_time_hours")
  joinedAt          DateTime      @default(now()) @map("joined_at")
  lastActiveAt      DateTime      @default(now()) @map("last_active_at")
  notes             String?       @map("notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  organization      Organization? @relation(fields: [orgId], references: [id])

  @@index([tenantId])
  @@index([orgId])
  @@map("team_members")
}

model Person {
  id                      String                    @id @default(cuid())
  tenantId                String
  organizationId          String
  ownerId                 String?
  firstName               String
  lastName                String
  primaryEmail            String?
  secondaryEmails         String[]                  @default([])
  primaryPhone            String?
  secondaryPhones         String[]                  @default([])
  stage                   PersonStage               @default(NEW)
  tags                    String[]                  @default([])
  source                  String?
  companyId               String?
  householdId             String?
  householdRole           String?
  utmSource               String?
  utmMedium               String?
  utmCampaign             String?
  gclid                   String?
  address                 String?
  leadScore               Float?
  buyerRepStatus          BuyerRepStatus            @default(NONE)
  doNotContact            Boolean                   @default(false)
  lastActivityAt          DateTime?
  preferredChannels       ConsentChannel[]          @default([])
  deletedAt               DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  pipelineId              String?
  stageId                 String?
  stageEnteredAt          DateTime?
  scoreTier               LeadScoreTier             @default(D)
  scoreUpdatedAt          DateTime?
  tenant                  Tenant                    @relation(fields: [tenantId], references: [id])
  organization            Organization              @relation(fields: [organizationId], references: [id])
  owner                   User?                     @relation("PersonOwner", fields: [ownerId], references: [id])
  company                 Company?                  @relation("CompanyContacts", fields: [companyId], references: [id])
  household               Household?                @relation("HouseholdMembers", fields: [householdId], references: [id])
  consents                Consent[]
  listings                Listing[]                 @relation("PersonListings")
  tours                   Tour[]
  agreements              Agreement[]
  deals                   Deal[]
  offers                  Offer[]
  messages                Message[]
  conversations           Conversation[]            @relation("PersonConversations")
  conversationMemberships ConversationParticipant[] @relation("ConversationParticipantPerson")
  activities              Activity[]
  assignments             Assignment[]
  documents               PersonDocument[]
  communicationBlocks     CommunicationBlock[]
  quietHourOverrides      QuietHourOverride[]
  routingLogs             RoutingLog[]
  calendarEvents          CalendarEvent[]
  mergeProposals          ContactMergeProposal[]    @relation("PersonMergeProposals")
  pipeline                Pipeline?                 @relation("PipelinePersons", fields: [pipelineId], references: [id])
  pipelineStage           Stage?                    @relation("StagePersons", fields: [stageId], references: [id])
  leadFit                 LeadFit?
  activityRollup          LeadActivityRollup?
  leadNotes               LeadNote[]
  leadTasks               LeadTask[]
  siteEvents              Event[]
  touchpoints             LeadTouchpoint[]
  cases                   Case[]                    @relation("CaseContact")
  primaryForCompanies     Company[]                 @relation("CompanyPrimaryContact")
  sequenceEnrollments     SequenceEnrollment[]
  customFieldValues       CustomFieldValue[]

  @@unique([tenantId, primaryEmail])
  @@unique([tenantId, primaryPhone])
  @@index([tenantId, deletedAt])
  @@index([tenantId, pipelineId])
  @@index([tenantId, stageId])
  @@index([tenantId, companyId])
  @@index([tenantId, householdId])
}

model Company {
  id               String       @id @default(cuid())
  tenantId         String
  organizationId   String
  ownerId          String?
  name             String
  legalName        String?
  industry         String?
  type             String?
  website          String?
  phone            String?
  email            String?
  tags             String[]     @default([])
  source           String?
  size             String?
  primaryContactId String?
  billingAddress   String?
  shippingAddress  String?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  tenant           Tenant       @relation(fields: [tenantId], references: [id])
  organization     Organization @relation(fields: [organizationId], references: [id])
  owner            User?        @relation("CompanyOwner", fields: [ownerId], references: [id])
  primaryContact   Person?      @relation("CompanyPrimaryContact", fields: [primaryContactId], references: [id])
  contacts         Person[]     @relation("CompanyContacts")
  deals            Deal[]

  @@index([tenantId, name])
  @@index([tenantId, ownerId])
  @@index([tenantId, primaryContactId])
}

model Household {
  id             String       @id @default(cuid())
  tenantId       String
  organizationId String
  ownerId        String?
  name           String?
  timezone       String?
  tags           String[]     @default([])
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  tenant         Tenant       @relation(fields: [tenantId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  owner          User?        @relation("HouseholdOwner", fields: [ownerId], references: [id])
  members        Person[]     @relation("HouseholdMembers")

  @@index([tenantId, ownerId])
}

model Pipeline {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  type      String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  stages    Stage[]
  leads     Person[] @relation("PipelinePersons")

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Stage {
  id         String   @id @default(cuid())
  tenantId   String
  pipelineId String
  name       String
  order      Int
  slaMinutes Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id])
  leads      Person[] @relation("StagePersons")

  @@unique([tenantId, pipelineId, name])
  @@index([tenantId])
  @@index([tenantId, pipelineId])
}

model LeadFit {
  id             String   @id @default(cuid())
  tenantId       String
  personId       String   @unique
  preapproved    Boolean  @default(false)
  budgetMin      Int?
  budgetMax      Int?
  timeframeDays  Int?
  geo            String?
  inventoryMatch Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  person         Person   @relation(fields: [personId], references: [id])

  @@index([tenantId])
}

model Event {
  id          String   @id @default(cuid())
  tenantId    String
  personId    String?
  anonymousId String?
  name        String
  timestamp   DateTime
  properties  Json?
  context     Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  person      Person?  @relation(fields: [personId], references: [id])

  @@index([tenantId])
  @@index([tenantId, personId])
  @@index([tenantId, name, timestamp])
}

model LeadActivityRollup {
  id                 String    @id @default(cuid())
  tenantId           String
  personId           String    @unique
  last7dListingViews Int       @default(0)
  last7dSessions     Int       @default(0)
  lastReplyAt        DateTime?
  lastEmailOpenAt    DateTime?
  lastTouchpointAt   DateTime?
  updatedAt          DateTime  @updatedAt
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  person             Person    @relation(fields: [personId], references: [id])

  @@index([tenantId])
}

model LeadNote {
  id        String   @id @default(cuid())
  tenantId  String
  personId  String
  userId    String
  body      String
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  person    Person   @relation(fields: [personId], references: [id])
  author    User     @relation("LeadNoteAuthor", fields: [userId], references: [id])

  @@index([tenantId, personId])
}

model LeadTouchpoint {
  id         String             @id @default(cuid())
  tenantId   String
  personId   String
  userId     String?
  type       LeadTouchpointType
  channel    MessageChannel?
  occurredAt DateTime
  summary    String?
  body       String?
  metadata   Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  tenant     Tenant             @relation(fields: [tenantId], references: [id])
  person     Person             @relation(fields: [personId], references: [id])
  user       User?              @relation(fields: [userId], references: [id])

  @@index([tenantId, personId, occurredAt])
}

model LeadTask {
  id         String         @id @default(cuid())
  tenantId   String
  personId   String
  assigneeId String?
  title      String
  dueAt      DateTime?
  status     LeadTaskStatus @default(OPEN)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  person     Person         @relation(fields: [personId], references: [id])
  assignee   User?          @relation("LeadTaskAssignee", fields: [assigneeId], references: [id])

  @@index([tenantId, personId])
}

model SavedView {
  id          String         @id @default(cuid())
  tenantId    String
  userId      String
  name        String
  scope       SavedViewScope @default(PRIVATE)
  teamId      String?
  description String?
  columns     Json?
  sort        Json?
  filters     Json
  isDefault   Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  team   Team?  @relation(fields: [teamId], references: [id])

  @@unique([userId, name])
  @@index([tenantId, scope])
  @@index([tenantId, teamId])
}

model Sequence {
  id              String               @id @default(cuid())
  tenantId        String
  organizationId  String
  name            String
  description     String?
  tags            String[]             @default([])
  steps           Json
  throttlePerDay  Int?
  quietHoursStart Int?
  quietHoursEnd   Int?
  active          Boolean              @default(true)
  stopOnReply     Boolean              @default(true)
  archivedAt      DateTime?
  createdById     String?
  updatedById     String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id])
  createdBy       User?                @relation("SequenceCreatedBy", fields: [createdById], references: [id])
  updatedBy       User?                @relation("SequenceUpdatedBy", fields: [updatedById], references: [id])
  enrollments     SequenceEnrollment[]
  stepLogs        SequenceStepLog[]

  @@unique([tenantId, name])
  @@index([tenantId, active])
}

model SequenceEnrollment {
  id             String                   @id @default(cuid())
  tenantId       String
  sequenceId     String
  personId       String
  ownerId        String?
  status         SequenceEnrollmentStatus @default(ACTIVE)
  currentStep    Int                      @default(0)
  startedAt      DateTime                 @default(now())
  nextRunAt      DateTime?
  lastExecutedAt DateTime?
  completedAt    DateTime?
  canceledAt     DateTime?
  stopReason     String?
  metadata       Json?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  tenant         Tenant                   @relation(fields: [tenantId], references: [id])
  sequence       Sequence                 @relation(fields: [sequenceId], references: [id])
  person         Person                   @relation(fields: [personId], references: [id])
  owner          User?                    @relation("SequenceEnrollmentOwner", fields: [ownerId], references: [id])
  stepLogs       SequenceStepLog[]

  @@unique([sequenceId, personId])
  @@index([tenantId, sequenceId])
  @@index([tenantId, personId])
  @@index([tenantId, status])
}

model SequenceStepLog {
  id           String             @id @default(cuid())
  tenantId     String
  sequenceId   String
  enrollmentId String
  stepIndex    Int
  stepPayload  Json?
  channel      MessageChannel?
  status       SequenceStepStatus @default(PENDING)
  scheduledFor DateTime?
  executedAt   DateTime?
  completedAt  DateTime?
  canceledAt   DateTime?
  messageId    String?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  sequence     Sequence           @relation(fields: [sequenceId], references: [id])
  enrollment   SequenceEnrollment @relation(fields: [enrollmentId], references: [id])

  @@index([tenantId, sequenceId])
  @@index([tenantId, enrollmentId])
  @@index([tenantId, status])
}

model CustomField {
  id             String             @id @default(cuid())
  tenantId       String
  organizationId String
  entity         CustomFieldEntity
  key            String
  label          String
  type           CustomFieldType
  description    String?
  placeholder    String?
  helpText       String?
  options        Json?
  defaultValue   Json?
  required       Boolean            @default(false)
  archived       Boolean            @default(false)
  createdById    String?
  updatedById    String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  tenant         Tenant             @relation(fields: [tenantId], references: [id])
  organization   Organization       @relation(fields: [organizationId], references: [id])
  createdBy      User?              @relation("CustomFieldCreatedBy", fields: [createdById], references: [id])
  updatedBy      User?              @relation("CustomFieldUpdatedBy", fields: [updatedById], references: [id])
  values         CustomFieldValue[]

  @@unique([tenantId, entity, key])
  @@index([tenantId, entity])
}

model CustomFieldValue {
  id        String      @id @default(cuid())
  tenantId  String
  fieldId   String
  personId  String?
  dealId    String?
  value     Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  field     CustomField @relation(fields: [fieldId], references: [id])
  person    Person?     @relation(fields: [personId], references: [id])
  deal      Deal?       @relation(fields: [dealId], references: [id])

  @@index([tenantId, fieldId])
  @@index([tenantId, personId])
  @@index([tenantId, dealId])
}

model CustomFieldLayout {
  id          String            @id @default(cuid())
  tenantId    String
  entity      CustomFieldEntity
  name        String
  description String?
  definition  Json
  isDefault   Boolean           @default(false)
  createdById String?
  updatedById String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  createdBy   User?             @relation("CustomFieldLayoutCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?             @relation("CustomFieldLayoutUpdatedBy", fields: [updatedById], references: [id])

  @@unique([tenantId, entity, name])
  @@index([tenantId, entity])
}

model ContactMergeProposal {
  id                String      @id @default(cuid())
  tenantId          String
  existingPersonId  String
  incomingPayload   Json
  proposedByUserId  String
  status            MergeStatus @default(PENDING)
  resolutionPayload Json?
  resolvedAt        DateTime?
  resolvedByUserId  String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  tenant         Tenant @relation(fields: [tenantId], references: [id])
  existingPerson Person @relation("PersonMergeProposals", fields: [existingPersonId], references: [id])
  proposedBy     User   @relation("MergeProposedBy", fields: [proposedByUserId], references: [id])
  resolvedBy     User?  @relation("MergeResolvedBy", fields: [resolvedByUserId], references: [id])

  @@index([tenantId, status])
}

model Consent {
  id           String         @id @default(cuid())
  tenantId     String
  personId     String
  channel      ConsentChannel
  scope        ConsentScope
  status       ConsentStatus  @default(GRANTED)
  verbatimText String
  source       String
  ipAddress    String?
  userAgent    String?
  evidenceUri  String?
  capturedAt   DateTime       @default(now())
  revokedAt    DateTime?
  actorUserId  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  person       Person         @relation(fields: [personId], references: [id])
  actor        User?          @relation("ConsentActor", fields: [actorUserId], references: [id])

  @@index([personId, channel, scope])
}

model Listing {
  id              String                 @id @default(cuid())
  tenantId        String
  personId        String?
  opportunityId   String?
  mlsId           String?
  status          ListingStatus          @default(COMING_SOON)
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  country         String                 @default("USA")
  latitude        Float?
  longitude       Float?
  price           Decimal?
  beds            Int?
  baths           Float?
  propertyType    String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  tenant          Tenant                 @relation(fields: [tenantId], references: [id])
  person          Person?                @relation("PersonListings", fields: [personId], references: [id])
  tours           Tour[]
  deals           Deal[]
  offers          Offer[]
  calendarEvents  CalendarEvent[]
  clearCoopTimer  ClearCooperationTimer? @relation("ListingTimer")
  activities      Activity[]
  marketingEvents MarketingEvent[]
  opportunity     Opportunity?           @relation(fields: [opportunityId], references: [id])

  @@index([opportunityId])
}

model CalendarEvent {
  id              String                @id @default(cuid())
  tenantId        String
  title           String
  description     String?
  startAt         DateTime
  endAt           DateTime
  eventType       CalendarEventType     @default(OTHER)
  status          CalendarEventStatus   @default(PENDING)
  priority        CalendarEventPriority @default(MEDIUM)
  location        String?
  notes           String?
  assignedAgentId String?
  personId        String?
  listingId       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  assignedAgent User?    @relation("EventAssignedAgent", fields: [assignedAgentId], references: [id])
  person        Person?  @relation(fields: [personId], references: [id])
  listing       Listing? @relation(fields: [listingId], references: [id])

  @@index([tenantId, startAt])
  @@index([assignedAgentId])
  @@index([personId])
}

model Tour {
  id            String             @id @default(cuid())
  tenantId      String
  personId      String
  listingId     String
  agentId       String?
  status        TourStatus         @default(REQUESTED)
  startAt       DateTime
  endAt         DateTime
  source        String?
  routingScore  Float?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  person        Person             @relation(fields: [personId], references: [id])
  listing       Listing            @relation(fields: [listingId], references: [id])
  agent         User?              @relation("TourAgent", fields: [agentId], references: [id])
  agreementLink TourAgreementLink?
  activities    Activity[]
}

model Agreement {
  id             String              @id @default(cuid())
  tenantId       String
  personId       String
  type           AgreementType
  status         AgreementStatus     @default(DRAFT)
  effectiveDate  DateTime?
  expiryDate     DateTime?
  version        Int                 @default(1)
  documentUri    String?
  signatureLog   Json?
  signedAt       DateTime?
  overrideUserId String?
  overrideReason String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  tenant         Tenant              @relation(fields: [tenantId], references: [id])
  person         Person              @relation(fields: [personId], references: [id])
  overrideUser   User?               @relation("AgreementOverride", fields: [overrideUserId], references: [id])
  deals          Deal[]
  tourLinks      TourAgreementLink[]
  activities     Activity[]

  @@index([personId, type, status])
}

model Deal {
  id                 String             @id @default(cuid())
  tenantId           String
  personId           String
  companyId          String?
  /// TODO(migrate): enforce NOT NULL + ON DELETE CASCADE
  listingId          String?
  agreementId        String?
  opportunityId      String?
  /// TODO(migrate): ensure stage remains NOT NULL with default 'OFFER'
  stage              DealStage          @default(OFFER)
  forecastGci        Decimal?
  actualGci          Decimal?
  splitPlanRef       String?
  spendToDate        Decimal?           @default(0)
  expectedNet        Decimal?
  commissionSnapshot Json?
  milestoneChecklist Json?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  tenant             Tenant             @relation(fields: [tenantId], references: [id])
  person             Person             @relation(fields: [personId], references: [id])
  company            Company?           @relation(fields: [companyId], references: [id])
  /// TODO(migrate): re_transactions.listingId ON DELETE CASCADE
  listing            Listing?           @relation(fields: [listingId], references: [id])
  agreement          Agreement?         @relation(fields: [agreementId], references: [id])
  offers             Offer[]
  activities         Activity[]
  opportunity        Opportunity?       @relation(fields: [opportunityId], references: [id])
  customFieldValues  CustomFieldValue[]

  @@index([opportunityId])
  @@index([tenantId, listingId]) // TODO(migrate): optimise transaction lookups by listing
  @@index([tenantId, stage]) // TODO(migrate): support transaction stage filters
  @@index([tenantId, companyId])
}

model Offer {
  id        String      @id @default(cuid())
  tenantId  String
  /// TODO(migrate): enforce NOT NULL + ON DELETE CASCADE
  listingId String
  personId  String
  dealId    String?
  /// TODO(migrate): ensure NOT NULL default 'SUBMITTED'
  status    OfferStatus @default(SUBMITTED)
  /// TODO(migrate): persist scalar amount column (NOT NULL) alongside terms JSON
  terms     Json
  version   Int         @default(1)
  metadata  Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  /// TODO(migrate): re_offers.listingId ON DELETE CASCADE
  listing   Listing     @relation(fields: [listingId], references: [id])
  person    Person      @relation(fields: [personId], references: [id])
  deal      Deal?       @relation(fields: [dealId], references: [id])
  /// TODO(migrate): partial unique index enforcing a single ACCEPTED offer per listing

  @@index([tenantId, listingId, status]) // TODO(migrate): cover listing offer queries
}

model MLSProfile {
  id                       String                  @id @default(cuid())
  tenantId                 String
  name                     String
  disclaimerText           String
  compensationDisplayRule  String
  requiredPlacement        String?                 @default("footer")
  prohibitedFields         Json?
  clearCooperationRequired Boolean                 @default(true)
  slaHours                 Int                     @default(72)
  lastReviewedAt           DateTime?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  tenant                   Tenant                  @relation(fields: [tenantId], references: [id])
  cooperationTimers        ClearCooperationTimer[]
  disclaimerPolicies       DisclaimerPolicy[]
  marketingEvents          MarketingEvent[]
}

model TourAgreementLink {
  tourId      String    @id
  agreementId String
  linkedAt    DateTime  @default(now())
  tour        Tour      @relation(fields: [tourId], references: [id], onDelete: Cascade)
  agreement   Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  @@index([agreementId])
}

model DisclaimerPolicy {
  id                String     @id @default(cuid())
  tenantId          String
  mlsProfileId      String
  requiredText      String
  requiredPlacement String
  compensationRule  String
  lastReviewedAt    DateTime   @default(now())
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  tenant            Tenant     @relation(fields: [tenantId], references: [id])
  mlsProfile        MLSProfile @relation(fields: [mlsProfileId], references: [id])

  @@index([tenantId, mlsProfileId])
}

model OverrideLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorUserId String?
  context     String
  reasonText  String?
  metadata    Json?
  occurredAt  DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  actor       User?    @relation("OverrideActor", fields: [actorUserId], references: [id])

  @@index([tenantId, context])
}

model MarketingEvent {
  id           String      @id @default(cuid())
  tenantId     String
  listingId    String?
  mlsProfileId String?
  eventType    String
  occurredAt   DateTime    @default(now())
  result       String?
  metadata     Json?
  tenant       Tenant      @relation(fields: [tenantId], references: [id])
  listing      Listing?    @relation(fields: [listingId], references: [id])
  mlsProfile   MLSProfile? @relation(fields: [mlsProfileId], references: [id])

  @@index([tenantId, occurredAt])
  @@index([listingId])
  @@index([mlsProfileId])
}

model ComplianceStatusDaily {
  id                String   @id @default(cuid())
  tenantId          String
  date              DateTime
  teamId            String?
  agentId           String?
  toursTotal        Int      @default(0)
  toursKept         Int      @default(0)
  keptWithActiveBba Int      @default(0)
  smsGranted        Int      @default(0)
  smsRevoked        Int      @default(0)
  emailGranted      Int      @default(0)
  emailRevoked      Int      @default(0)
  coopOpen          Int      @default(0)
  coopOverdue       Int      @default(0)
  idxFailures       Int      @default(0)
  idxChecks         Int      @default(0)
  tenDlcApproved    Boolean  @default(false)
  dmarcAligned      Boolean  @default(false)
  createdAt         DateTime @default(now())
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, date, teamId, agentId])
}

model CommissionPlan {
  id          String             @id @default(cuid())
  tenantId    String
  name        String
  type        CommissionPlanType
  description String?
  definition  Json
  postCapFee  Json?
  bonusRules  Json?
  isArchived  Boolean            @default(false)
  version     Int                @default(1)
  createdById String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  createdBy   User?              @relation("CommissionPlanCreatedBy", fields: [createdById], references: [id])
  assignments PlanAssignment[]
  snapshots   PlanSnapshot[]
  capLedgers  CapLedger[]

  @@unique([tenantId, name, version])
  @@index([tenantId, isArchived])
}

model PlanAssignment {
  id            String           @id @default(cuid())
  tenantId      String
  assigneeType  PlanAssigneeType
  assigneeId    String
  planId        String
  effectiveFrom DateTime
  effectiveTo   DateTime?
  priority      Int              @default(0)
  createdById   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  plan          CommissionPlan   @relation(fields: [planId], references: [id])
  createdBy     User?            @relation("PlanAssignmentCreatedBy", fields: [createdById], references: [id])

  @@unique([tenantId, assigneeType, assigneeId, planId, effectiveFrom])
  @@index([tenantId, assigneeType, assigneeId, effectiveFrom])
}

model CapLedger {
  id               String         @id @default(cuid())
  tenantId         String
  userId           String
  planId           String
  periodStart      DateTime
  periodEnd        DateTime
  capAmount        Decimal        @db.Decimal(12, 2)
  companyDollarYtd Decimal        @default(0) @db.Decimal(12, 2)
  postCapFeesYtd   Decimal        @default(0) @db.Decimal(12, 2)
  lastDealId       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  tenant           Tenant         @relation(fields: [tenantId], references: [id])
  user             User           @relation(fields: [userId], references: [id])
  plan             CommissionPlan @relation(fields: [planId], references: [id])

  @@unique([tenantId, userId, planId, periodStart])
  @@index([tenantId, userId, planId, periodStart, periodEnd])
}

model PlanSnapshot {
  id          String         @id @default(cuid())
  tenantId    String
  planId      String
  version     Int
  payload     Json
  createdAt   DateTime       @default(now())
  createdById String?
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  plan        CommissionPlan @relation(fields: [planId], references: [id])
  createdBy   User?          @relation("PlanSnapshotCreatedBy", fields: [createdById], references: [id])

  @@unique([planId, version])
  @@index([tenantId, planId, version])
}

model RoutingRule {
  id                        String           @id @default(cuid())
  tenantId                  String
  name                      String
  priority                  Int              @default(0)
  mode                      RoutingMode      @default(FIRST_MATCH)
  enabled                   Boolean          @default(true)
  conditions                Json
  targets                   Json
  fallback                  Json?
  slaFirstTouchMinutes      Int?
  slaKeptAppointmentMinutes Int?
  createdById               String?
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  tenant                    Tenant           @relation(fields: [tenantId], references: [id])
  createdBy                 User?            @relation("RoutingRuleCreatedBy", fields: [createdById], references: [id])
  routeEvents               LeadRouteEvent[]
  slaTimers                 LeadSlaTimer[]

  @@index([tenantId, priority])
}

model LeadRouteEvent {
  id              String       @id @default(cuid())
  tenantId        String
  leadId          String
  personId        String?
  matchedRuleId   String?
  mode            RoutingMode
  payload         Json
  candidates      Json
  assignedAgentId String?
  fallbackUsed    Boolean      @default(false)
  reasonCodes     Json?
  slaDueAt        DateTime?
  slaSatisfiedAt  DateTime?
  slaBreachedAt   DateTime?
  actorUserId     String?
  createdAt       DateTime     @default(now())
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  rule            RoutingRule? @relation(fields: [matchedRuleId], references: [id])
  actor           User?        @relation("RouteEventActor", fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, leadId])
}

model LeadSlaTimer {
  id              String       @id @default(cuid())
  tenantId        String
  leadId          String
  assignedAgentId String?
  ruleId          String?
  type            LeadSlaType  @default(FIRST_TOUCH)
  status          String       @default("PENDING")
  dueAt           DateTime
  satisfiedAt     DateTime?
  breachedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  rule            RoutingRule? @relation(fields: [ruleId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, status])
}

model Message {
  id                String              @id @default(cuid())
  tenantId          String
  personId          String?
  userId            String?
  conversationId    String?
  channel           MessageChannel
  direction         MessageDirection
  subject           String?
  body              String?
  toAddress         String?
  fromAddress       String?
  status            MessageStatus       @default(QUEUED)
  errorCode         String?
  errorMessage      String?
  metadata          Json?
  deliveredAt       DateTime?
  providerMessageId String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  tenant            Tenant              @relation(fields: [tenantId], references: [id])
  person            Person?             @relation(fields: [personId], references: [id])
  user              User?               @relation(fields: [userId], references: [id])
  conversation      Conversation?       @relation(fields: [conversationId], references: [id])
  attachments       MessageAttachment[]
  receipts          MessageReceipt[]

  @@index([conversationId])
}

model Conversation {
  id           String                    @id @default(cuid())
  tenantId     String
  type         ConversationType
  personId     String?
  createdById  String
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  archivedAt   DateTime?
  tenant       Tenant                    @relation(fields: [tenantId], references: [id])
  person       Person?                   @relation("PersonConversations", fields: [personId], references: [id])
  createdBy    User                      @relation("ConversationCreatedBy", fields: [createdById], references: [id])
  participants ConversationParticipant[]
  messages     Message[]

  @@index([tenantId, type])
  @@index([tenantId, personId])
  @@index([tenantId, updatedAt])
}

model ConversationParticipant {
  id             String                      @id @default(cuid())
  conversationId String
  userId         String?
  personId       String?
  role           ConversationParticipantRole @default(MEMBER)
  joinedAt       DateTime                    @default(now())
  muted          Boolean                     @default(false)
  lastReadAt     DateTime?
  conversation   Conversation                @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?                       @relation("ConversationParticipantUser", fields: [userId], references: [id])
  person         Person?                     @relation("ConversationParticipantPerson", fields: [personId], references: [id])
  receipts       MessageReceipt[]

  @@index([conversationId, role])
  @@index([conversationId, userId])
  @@index([conversationId, personId])
}

model MessageReceipt {
  id            String                  @id @default(cuid())
  messageId     String
  participantId String
  status        MessageReceiptStatus
  recordedAt    DateTime                @default(now())
  message       Message                 @relation(fields: [messageId], references: [id], onDelete: Cascade)
  participant   ConversationParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([messageId, participantId, status])
  @@index([participantId, status])
}

model MessageAttachment {
  id         String   @id @default(cuid())
  messageId  String
  filename   String
  mimeType   String
  size       Int
  storageKey String
  checksum   String?
  scanned    Boolean  @default(false)
  createdAt  DateTime @default(now())
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([checksum])
}

model Activity {
  id          String       @id @default(cuid())
  tenantId    String
  personId    String?
  userId      String?
  dealId      String?
  tourId      String?
  agreementId String?
  listingId   String?
  type        ActivityType
  payload     Json
  occurredAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  person      Person?      @relation(fields: [personId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])
  deal        Deal?        @relation(fields: [dealId], references: [id])
  tour        Tour?        @relation(fields: [tourId], references: [id])
  agreement   Agreement?   @relation(fields: [agreementId], references: [id])
  listing     Listing?     @relation(fields: [listingId], references: [id])
}

model Outbox {
  id          String            @id @default(cuid())
  tenantId    String
  eventType   String
  payload     Json
  status      OutboxStatus      @default(PENDING)
  attempts    Int               @default(0)
  lastError   String?
  lockedAt    DateTime?
  nextRetryAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  deliveries  WebhookDelivery[]
}

model Assignment {
  id         String             @id @default(cuid())
  tenantId   String
  personId   String
  agentId    String?
  teamId     String?
  score      Float
  reasons    AssignmentReason[]
  assignedAt DateTime           @default(now())
  expiresAt  DateTime?
  createdAt  DateTime           @default(now())
  tenant     Tenant             @relation(fields: [tenantId], references: [id])
  person     Person             @relation(fields: [personId], references: [id])
  agent      User?              @relation(fields: [agentId], references: [id])
  team       Team?              @relation(fields: [teamId], references: [id])
}

model AssignmentReason {
  id           String               @id @default(cuid())
  assignmentId String
  type         AssignmentReasonType
  weight       Float
  notes        String?
  assignment   Assignment           @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model Journey {
  id          String              @id @default(cuid())
  tenantId    String
  name        String
  trigger     JourneyTrigger
  isActive    Boolean             @default(true)
  definition  Json // conditions + actions structure
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  simulations JourneySimulation[]
}

model JourneySimulation {
  id        String   @id @default(cuid())
  journeyId String
  input     Json
  result    Json
  createdAt DateTime @default(now())
  journey   Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)
}

model CommunicationBlock {
  id        String         @id @default(cuid())
  tenantId  String
  personId  String?
  channel   ConsentChannel
  scope     ConsentScope?
  reason    String
  createdAt DateTime       @default(now())
  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  person    Person?        @relation(fields: [personId], references: [id])

  @@index([personId, channel])
}

model ClearCooperationTimer {
  id                     String                 @id @default(cuid())
  tenantId               String
  listingId              String?                @unique
  mlsProfileId           String?
  status                 ClearCooperationStatus @default(GREEN)
  startedAt              DateTime               @default(now())
  firstPublicMarketingAt DateTime?
  deadlineAt             DateTime?
  dueAt                  DateTime?
  lastEventAt            DateTime?
  riskReason             String?
  lastAction             String?
  lastActorId            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  tenant                 Tenant                 @relation(fields: [tenantId], references: [id])
  listing                Listing?               @relation("ListingTimer", fields: [listingId], references: [id])
  mlsProfile             MLSProfile?            @relation(fields: [mlsProfileId], references: [id])
  lastActor              User?                  @relation("CooperationLastActor", fields: [lastActorId], references: [id])
}

model PersonDocument {
  id        String   @id @default(cuid())
  personId  String
  tenantId  String
  type      String
  url       String
  createdAt DateTime @default(now())
  metadata  Json?
  person    Person   @relation(fields: [personId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  before      Json?
  after       Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  actor       User?    @relation(fields: [actorUserId], references: [id])
}

model DeliverabilityMetric {
  id          String         @id @default(cuid())
  tenantId    String
  campaignRef String?
  agentId     String?
  channel     MessageChannel
  accepted    Int            @default(0)
  delivered   Int            @default(0)
  bounced     Int            @default(0)
  complaints  Int            @default(0)
  optOuts     Int            @default(0)
  recordedAt  DateTime       @default(now())
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  agent       User?          @relation(fields: [agentId], references: [id])

  @@unique([tenantId, agentId, channel, recordedAt])
}

model QuietHourOverride {
  id         String         @id @default(cuid())
  tenantId   String
  personId   String?
  channel    ConsentChannel
  reason     String
  validUntil DateTime
  createdAt  DateTime       @default(now())
  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  person     Person?        @relation(fields: [personId], references: [id])
}

model RoutingLog {
  id          String   @id @default(cuid())
  tenantId    String
  personId    String
  ruleName    String
  prevOwnerId String?
  newOwnerId  String?
  details     Json?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  person      Person   @relation(fields: [personId], references: [id])

  @@index([tenantId, personId])
}

model WebhookSubscription {
  id         String            @id @default(cuid())
  tenantId   String
  name       String
  url        String
  secret     String
  isActive   Boolean           @default(true)
  eventTypes String[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  tenant     Tenant            @relation(fields: [tenantId], references: [id])
  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id          String              @id @default(cuid())
  webhookId   String
  outboxId    String
  status      OutboxStatus        @default(PENDING)
  attempts    Int                 @default(0)
  lastError   String?
  deliveredAt DateTime?
  createdAt   DateTime            @default(now())
  webhook     WebhookSubscription @relation(fields: [webhookId], references: [id])
  outbox      Outbox              @relation(fields: [outboxId], references: [id])
}

model UserOrgMembership {
  id         String       @id @default(cuid())
  userId     String
  orgId      String
  roleId     String?
  profileId  String?
  isOrgAdmin Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id])
  org        Organization @relation(fields: [orgId], references: [id])
  role       Role?        @relation("RoleMemberships", fields: [roleId], references: [id])
  profile    Profile?     @relation(fields: [profileId], references: [id])

  @@unique([userId, orgId])
  @@index([orgId])
  @@index([profileId])
}

model Role {
  id        String              @id @default(cuid())
  orgId     String
  name      String
  parentId  String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  org       Organization        @relation(fields: [orgId], references: [id])
  parent    Role?               @relation("RoleToRole", fields: [parentId], references: [id])
  children  Role[]              @relation("RoleToRole")
  members   UserOrgMembership[] @relation("RoleMemberships")

  @@index([orgId])
}

model Profile {
  id                String              @id @default(cuid())
  orgId             String
  name              String
  isSystem          Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  org               Organization        @relation(fields: [orgId], references: [id])
  objectPermissions ObjectPermission[]  @relation("ProfileObjectPermissions")
  fieldPermissions  FieldPermission[]   @relation("ProfileFieldPermissions")
  memberships       UserOrgMembership[]

  @@index([orgId])
}

model PermissionSet {
  id                String                    @id @default(cuid())
  orgId             String
  name              String
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  org               Organization              @relation(fields: [orgId], references: [id])
  assignments       PermissionSetAssignment[]
  objectPermissions ObjectPermission[]        @relation("PermissionSetObjectPermissions")
  fieldPermissions  FieldPermission[]         @relation("PermissionSetFieldPermissions")

  @@index([orgId])
}

model PermissionSetAssignment {
  id              String        @id @default(cuid())
  userId          String
  permissionSetId String
  assignedAt      DateTime      @default(now())
  user            User          @relation(fields: [userId], references: [id])
  permissionSet   PermissionSet @relation(fields: [permissionSetId], references: [id])

  @@unique([userId, permissionSetId])
  @@index([permissionSetId])
}

model ObjectPermission {
  id              String               @id @default(cuid())
  orgId           String
  holderType      PermissionHolderType
  holderId        String
  object          String
  canCreate       Boolean              @default(false)
  canRead         Boolean              @default(true)
  canUpdate       Boolean              @default(false)
  canDelete       Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  org             Organization         @relation(fields: [orgId], references: [id])
  profileId       String?
  permissionSetId String?
  profile         Profile?             @relation("ProfileObjectPermissions", fields: [profileId], references: [id])
  permissionSet   PermissionSet?       @relation("PermissionSetObjectPermissions", fields: [permissionSetId], references: [id])

  @@index([orgId, holderType, holderId, object])
  @@index([profileId])
  @@index([permissionSetId])
}

model FieldPermission {
  id              String               @id @default(cuid())
  orgId           String
  holderType      PermissionHolderType
  holderId        String
  object          String
  field           String
  canRead         Boolean              @default(true)
  canWrite        Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  org             Organization         @relation(fields: [orgId], references: [id])
  profileId       String?
  permissionSetId String?
  profile         Profile?             @relation("ProfileFieldPermissions", fields: [profileId], references: [id])
  permissionSet   PermissionSet?       @relation("PermissionSetFieldPermissions", fields: [permissionSetId], references: [id])

  @@index([orgId, holderType, holderId, object, field])
  @@index([profileId])
  @@index([permissionSetId])
}

model RecordShare {
  id          String           @id @default(cuid())
  orgId       String
  object      String
  recordId    String
  granteeType ShareGranteeType
  granteeId   String
  access      ShareAccess
  createdAt   DateTime         @default(now())
  org         Organization     @relation(fields: [orgId], references: [id])

  @@index([orgId, object, recordId])
}

model AuditEvent {
  id        String       @id @default(cuid())
  orgId     String
  actorId   String?
  object    String?
  recordId  String?
  action    AuditAction
  diff      Json?
  ip        String?
  userAgent String?
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id])
  actor     User?        @relation(fields: [actorId], references: [id])

  @@index([orgId, object, recordId])
}

/// Admin-configured validation rules per object
model ValidationRule {
  id        String   @id @default(uuid())
  orgId     String
  object    String // e.g., 'cases','opportunities','accounts','re_offers'
  name      String
  active    Boolean  @default(true)
  // Simple JSON DSL, e.g. { "if": "status in ['Resolved','Closed']", "then_required": ["description"] }
  dsl       Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, object, active])
}

/// Admin-configured assignment rules per object
model AssignmentRule {
  id        String   @id @default(uuid())
  orgId     String
  object    String
  name      String
  active    Boolean  @default(true)
  // DSL example: { "when": "stage == 'Qualification' && amount >= 50000",
  //                "assign": { "type": "round_robin", "pool": ["u1","u2"] } }
  dsl       Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, object, active])
}

// TODO(migrate): consider NOT NULLs for object/name; add FKs to users for static assignees later

model Account {
  id              String        @id @default(uuid())
  orgId           String
  ownerId         String
  name            String
  website         String?
  industry        String?
  annualRevenue   Decimal?      @db.Decimal(18, 2)
  phone           String?
  billingAddress  Json?
  shippingAddress Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?
  opportunities   Opportunity[]
  cases           Case[]        @relation("CaseAccount")

  @@index([orgId, name])
}

model Opportunity {
  id           String    @id @default(uuid())
  orgId        String
  ownerId      String
  accountId    String?
  name         String
  stage        String
  amount       Decimal?  @db.Decimal(18, 2)
  currency     String    @default("USD")
  closeDate    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  account      Account?  @relation(fields: [accountId], references: [id])
  listings     Listing[]
  transactions Deal[]

  @@index([orgId, stage, closeDate])
}

model FileObject {
  id         String     @id @default(uuid())
  orgId      String
  ownerId    String
  fileName   String
  mimeType   String?
  byteSize   Int
  storageKey String
  status     String     @default("READY")
  createdAt  DateTime   @default(now())
  links      FileLink[]

  @@index([orgId, storageKey])
}

model FileLink {
  id        String     @id @default(uuid())
  orgId     String
  fileId    String
  object    String
  recordId  String
  createdAt DateTime   @default(now())
  file      FileObject @relation(fields: [fileId], references: [id])

  @@index([orgId, object, recordId])
}

model DealDeskRequest {
  id            String    @id @default(uuid())
  orgId         String
  requesterId   String
  opportunityId String
  status        String    @default("PENDING")
  amount        Decimal?  @db.Decimal(18, 2)
  discountPct   Decimal?  @db.Decimal(5, 2)
  reason        String?
  createdAt     DateTime  @default(now())
  decidedAt     DateTime?
  decidedBy     String?

  @@index([orgId, status, opportunityId])
}

model OrgCommissionPlan {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  brokerSplit Decimal  @db.Decimal(5, 2)
  agentSplit  Decimal  @db.Decimal(5, 2)
  tiers       Json?
  createdAt   DateTime @default(now())

  @@index([orgId, name])
}

model MetricsDaily {
  id        String   @id @default(cuid())
  orgId     String
  key       String
  date      DateTime
  valueNum  Decimal?
  valueJson Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, key, date])
}

model MetricsRun {
  id         String    @id @default(cuid())
  orgId      String
  key        String
  status     String
  note       String?
  createdAt  DateTime  @default(now())
  finishedAt DateTime?

  @@index([orgId, key, createdAt])
}

model Case {
  id          String    @id @default(uuid())
  orgId       String
  ownerId     String
  accountId   String?
  contactId   String?
  subject     String
  status      String    @default("New") // New|Working|Escalated|Resolved|Closed
  priority    String?   @default("Medium") // Low|Medium|High|Urgent
  origin      String? // Email|Phone|Web|Other
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  account Account? @relation("CaseAccount", fields: [accountId], references: [id])
  contact Person?  @relation("CaseContact", fields: [contactId], references: [id])

  @@index([orgId, status, priority])
}

// TODO(migrate): add NOT NULL where noted by service checks; confirm FK options

model Payout {
  id            String    @id @default(uuid())
  orgId         String
  transactionId String?
  opportunityId String?
  payeeId       String
  grossAmount   Decimal   @db.Decimal(18, 2)
  brokerAmount  Decimal   @db.Decimal(18, 2)
  agentAmount   Decimal   @db.Decimal(18, 2)
  status        String    @default("PENDING")
  dueOn         DateTime?
  paidAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([orgId, status])
}

// S9: Record Types & Layouts
model RecordType {
  id        String         @id @default(cuid())
  orgId     String
  object    String
  key       String
  label     String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  layouts   ObjectLayout[]

  @@unique([orgId, object, key])
  @@index([orgId, object])
}

model ObjectLayout {
  id           String        @id @default(cuid())
  orgId        String
  object       String
  kind         String
  recordTypeId String?
  profile      String?
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  recordType   RecordType?   @relation(fields: [recordTypeId], references: [id])
  fields       FieldLayout[]

  @@unique([orgId, object, kind, recordTypeId, profile])
  @@index([orgId, object, kind])
  @@index([orgId, object, kind, profile])
  @@index([orgId, object, kind, recordTypeId, profile])
}

model FieldLayout {
  id        String       @id @default(cuid())
  layoutId  String
  field     String
  label     String?
  visible   Boolean      @default(true)
  order     Int
  width     Int?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  layout    ObjectLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId, order])
}
