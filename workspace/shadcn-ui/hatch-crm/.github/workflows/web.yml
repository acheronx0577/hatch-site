name: Web Lint & Tests

on:
  pull_request:
    paths:
      - 'apps/web/**'
      - 'apps/api/src/modules/**'
      - 'apps/api/src/docs/**'
      - 'scripts/**'
      - 'package.json'

jobs:
  web:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=3072
      VITEST_MAX_THREADS: '2'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: pnpm
      - run: pnpm install --ignore-scripts
      - name: Lint (web)
        run: pnpm --filter @hatch/web lint
      - name: Web tests shard 1/2
        run: pnpm web:test:shard:1
      - name: Web tests shard 2/2
        run: pnpm web:test:shard:2

  spec-smoke:
    runs-on: ubuntu-latest
    needs: web
    if: |
      contains(join(github.event.pull_request.changed_files, '\n'), 'apps/api/src/modules/')
      || contains(join(github.event.pull_request.changed_files, '\n'), 'apps/api/src/docs/')
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: pnpm
      - run: pnpm install --ignore-scripts
      - name: OpenAPI smoke
        run: pnpm run spec:verify
